<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Math Stars - Multiplikations√§ventyr!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --bg-start: #667eea;
            --bg-mid: #764ba2;
            --bg-end: #f093fb;
            --card-bg: white;
            --text: #333;
            --text-light: #666;
        }

        .theme-space {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #e94560;
            --bg-start: #0f0f23;
            --bg-mid: #1a1a2e;
            --bg-end: #16213e;
            --card-bg: rgba(255,255,255,0.95);
        }

        .theme-ocean {
            --primary: #0077b6;
            --secondary: #00b4d8;
            --accent: #90e0ef;
            --bg-start: #03045e;
            --bg-mid: #0077b6;
            --bg-end: #00b4d8;
            --card-bg: rgba(255,255,255,0.95);
        }

        .theme-forest {
            --primary: #2d6a4f;
            --secondary: #40916c;
            --accent: #95d5b2;
            --bg-start: #1b4332;
            --bg-mid: #2d6a4f;
            --bg-end: #52b788;
            --card-bg: rgba(255,255,255,0.95);
        }

        .theme-unicorn {
            --primary: #ff6b9d;
            --secondary: #c44569;
            --accent: #ffc8dd;
            --bg-start: #ff6b9d;
            --bg-mid: #c44569;
            --bg-end: #ffc8dd;
            --card-bg: rgba(255,255,255,0.98);
        }

        /* Theme: Skibidi/Skull */
        .theme-skull {
            --primary: #1a1a1a;
            --secondary: #ff0044;
            --accent: #00ff88;
            --bg-start: #0d0d0d;
            --bg-mid: #1a1a1a;
            --bg-end: #2d1f3d;
            --card-bg: rgba(20,20,20,0.95);
            --text: #fff;
            --text-light: #aaa;
        }

        .theme-skull .container {
            color: #fff;
            border: 2px solid #ff0044;
            box-shadow: 0 0 30px rgba(255,0,68,0.5), 0 0 60px rgba(0,255,136,0.3);
        }

        .theme-skull .title {
            animation: glitch 0.5s infinite;
        }

        @keyframes glitch {
            0%, 90%, 100% { transform: translate(0); }
            92% { transform: translate(-2px, 2px); }
            94% { transform: translate(2px, -2px); }
            96% { transform: translate(-2px, -2px); }
            98% { transform: translate(2px, 2px); }
        }

        /* Theme: GOAT */
        .theme-goat {
            --primary: #ffd700;
            --secondary: #ff8c00;
            --accent: #fff700;
            --bg-start: #1a1a2e;
            --bg-mid: #16213e;
            --bg-end: #0f3460;
            --card-bg: rgba(255,255,255,0.95);
        }

        .theme-goat .container {
            border: 3px solid gold;
            box-shadow: 0 0 40px rgba(255,215,0,0.6);
        }

        .theme-goat .title {
            animation: rainbow 2s linear infinite;
        }

        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        html, body {
            overflow-x: hidden;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-mid) 50%, var(--bg-end) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            transition: background 0.5s;
            width: 100%;
            max-width: 100vw;
        }

        .container {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-height: 95vh;
            overflow-y: auto;
        }

        .title {
            font-size: 2em;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .subtitle {
            color: var(--text-light);
            margin-bottom: 15px;
            font-size: 1em;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--secondary);
        }

        .stat-label {
            font-size: 0.75em;
            color: var(--text-light);
        }

        .streak-display {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .streak-fire {
            font-size: 1.3em;
            animation: bounce 0.5s ease infinite alternate;
        }

        @keyframes bounce {
            from { transform: scale(1); }
            to { transform: scale(1.2); }
        }

        .question-area {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 15px;
        }

        .question {
            font-size: 2.2em;
            color: var(--text);
            margin-bottom: 15px;
        }

        .timer-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #00b894, #fdcb6e, #e17055);
            border-radius: 4px;
            transition: width 0.1s linear;
        }

        .answer-input {
            font-size: 1.8em;
            width: 120px;
            padding: 10px;
            border: 3px solid var(--secondary);
            border-radius: 15px;
            text-align: center;
            outline: none;
            transition: all 0.3s;
        }

        .answer-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(240, 147, 251, 0.5);
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 12px 35px;
            font-size: 1.2em;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .feedback {
            font-size: 1.3em;
            margin: 12px 0;
            min-height: 35px;
            font-weight: bold;
        }

        .feedback.correct {
            color: #00b894;
            animation: pop 0.3s ease;
        }

        .feedback.incorrect {
            color: #e17055;
            animation: shake 0.3s ease;
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .encouragement {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--primary);
            margin: 10px 0;
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 20px;
            display: inline-block;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .encouragement.visible {
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes bounce-in {
            0% { opacity: 0; transform: scale(0.8) translateY(10px); }
            50% { transform: scale(1.05) translateY(-2px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .encouragement.pop {
            animation: bounce-in 0.4s ease forwards;
        }

        .tip-box {
            background: linear-gradient(135deg, #fddb92 0%, #d1fdff 100%);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
            display: none;
        }

        .tip-box.visible {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tip-title {
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        .tip-content {
            color: var(--text);
            font-size: 0.95em;
            line-height: 1.4;
        }

        .tip-continue-btn {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .tip-continue-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .achievements-section {
            margin-top: 15px;
        }

        .achievements-title {
            font-size: 1.2em;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .badges-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }

        .badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
        }

        .badge.locked {
            background: #ddd;
            filter: grayscale(100%);
            opacity: 0.5;
        }

        .badge.unlocked {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            box-shadow: 0 5px 15px rgba(252, 182, 159, 0.5);
        }

        .badge-tooltip {
            position: absolute;
            bottom: -35px;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.45em;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 100;
        }

        .badge:hover .badge-tooltip {
            opacity: 1;
        }

        .level-display {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 12px;
            font-size: 1em;
        }

        .progress-bar-container {
            background: #eee;
            border-radius: 10px;
            height: 15px;
            margin: 8px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: fall 3s ease-out forwards;
        }

        @keyframes fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .screen {
            display: none;
            overflow-x: hidden;
            max-width: 100%;
        }

        .screen.active {
            display: block;
        }

        .start-btn, .mode-btn-large {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.3em;
            border-radius: 30px;
            cursor: pointer;
            margin: 8px;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0, 184, 148, 0.4);
        }

        .start-btn:hover, .mode-btn-large:hover {
            transform: translateY(-3px) scale(1.02);
        }

        .boss-btn {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
        }

        .math-type-btn, .difficulty-btn {
            background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
            color: #2d3436;
            border: 2px solid transparent;
            padding: 8px 14px;
            font-size: 0.95em;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .math-type-btn:hover, .difficulty-btn:hover {
            transform: scale(1.05);
        }

        .math-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #5a4fcf;
        }

        .difficulty-btn.active {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
        }

        .mascot {
            font-size: 3.5em;
            margin-bottom: 5px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .daily-goal {
            background: linear-gradient(135deg, #fddb92 0%, #d1fdff 100%);
            border-radius: 15px;
            padding: 12px;
            margin: 12px 0;
        }

        .shop-preview {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            border-radius: 15px;
            padding: 12px;
            margin: 15px 0;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            color: white;
        }

        .shop-preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(108, 92, 231, 0.4);
        }

        .shop-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .shop-preview-arrow {
            font-size: 1.2em;
        }

        .shop-preview-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .shop-preview-mascot {
            font-size: 2em;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .shop-preview-info {
            flex: 1;
            text-align: left;
        }

        .shop-preview-name {
            font-weight: bold;
            font-size: 0.95em;
        }

        .shop-preview-progress {
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }

        .shop-preview-fill {
            height: 100%;
            background: #ffeaa7;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .shop-preview-cost {
            font-size: 0.8em;
            opacity: 0.9;
            margin-top: 3px;
        }

        .heatmap {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            gap: 3px;
            margin: 15px 0;
            font-size: 0.7em;
            max-width: 100%;
            overflow-x: auto;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .heatmap-cell:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .heatmap-header {
            background: var(--secondary);
            color: white;
        }

        .heatmap-mastered { background: #00b894; color: white; }
        .heatmap-good { background: #55efc4; }
        .heatmap-learning { background: #fdcb6e; }
        .heatmap-weak { background: #fab1a0; }
        .heatmap-new { background: #dfe6e9; }

        .theme-selector {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 15px 0;
        }

        .skin-card {
            background: white;
            border-radius: 15px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .skin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .skin-card.selected {
            border-color: var(--primary);
        }

        .skin-card.locked {
            opacity: 0.85;
        }

        .skin-mascot {
            font-size: 2.5em;
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .skin-info {
            flex: 1;
            text-align: left;
            min-width: 0;
        }

        .skin-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .skin-name {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--text);
        }

        .skin-rarity {
            font-size: 0.7em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .rarity-common { background: #dfe6e9; color: #636e72; }
        .rarity-uncommon { background: #55efc4; color: #00b894; }
        .rarity-rare { background: #74b9ff; color: #0984e3; }
        .rarity-epic { background: #a29bfe; color: #6c5ce7; }
        .rarity-legendary { background: #ffeaa7; color: #fdcb6e; }
        .rarity-mythic { background: linear-gradient(90deg, #fd79a8, #a29bfe, #74b9ff); color: white; }

        .skin-desc {
            font-size: 0.85em;
            color: var(--text-light);
            margin-bottom: 6px;
        }

        .skin-progress {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        .skin-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .skin-cost {
            font-size: 0.8em;
            color: var(--text-light);
            margin-top: 4px;
        }

        .skin-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.7em;
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: bold;
        }

        .badge-owned {
            background: #00b894;
            color: white;
        }

        .badge-equipped {
            background: var(--primary);
            color: white;
        }

        .coins-display {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            border-radius: 15px;
            padding: 12px 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.2em;
            font-weight: bold;
            color: #6c5ce7;
        }

        .theme-default { background: linear-gradient(135deg, #667eea, #f093fb); }
        .theme-space { background: linear-gradient(135deg, #0f0f23, #1a1a2e); }
        .theme-ocean { background: linear-gradient(135deg, #03045e, #00b4d8); }
        .theme-forest { background: linear-gradient(135deg, #1b4332, #52b788); }
        .theme-unicorn { background: linear-gradient(135deg, #ff6b9d, #ffc8dd); }
        .theme-skull { background: linear-gradient(135deg, #0d0d0d, #ff0044); }
        .theme-goat { background: linear-gradient(135deg, #ffd700, #ff8c00); }

        .boss-emoji {
            font-size: 4em;
            animation: bossFloat 1s ease-in-out infinite;
        }

        @keyframes bossFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-15px) scale(1.1); }
        }

        .boss-health-bar {
            background: #eee;
            border-radius: 10px;
            height: 25px;
            margin: 15px 0;
            overflow: hidden;
            border: 2px solid #333;
        }

        .boss-health-fill {
            height: 100%;
            background: linear-gradient(90deg, #e17055, #d63031);
            transition: width 0.3s;
        }

        .boss-name {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--secondary);
            margin: 10px 0;
        }

        .daily-challenge-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
        }

        .nav-btn {
            padding: 10px 20px;
            margin: 5px;
            border: 2px solid var(--secondary);
            background: white;
            color: var(--secondary);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .nav-btn:hover {
            background: var(--secondary);
            color: white;
        }

        .table-select {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
            margin: 10px 0;
        }

        .table-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--secondary);
            background: white;
            color: var(--secondary);
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .table-btn.selected {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .table-btn.mastered {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            border-color: #00b894;
        }

        .smart-indicator {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 10px;
            padding: 8px 15px;
            margin: 10px 0;
            font-size: 0.85em;
            color: var(--text-light);
        }

        /* Login & Profile Styles */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .avatar-option {
            font-size: 2.5em;
            padding: 10px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0f0f0;
            border: 3px solid transparent;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            background: #e0e0e0;
        }

        .avatar-option.selected {
            border-color: var(--secondary);
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            transform: scale(1.15);
        }

        .name-input {
            font-size: 1.3em;
            padding: 12px 20px;
            border: 3px solid var(--secondary);
            border-radius: 15px;
            text-align: center;
            outline: none;
            width: 80%;
            max-width: 250px;
            margin: 10px 0;
        }

        .name-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(240, 147, 251, 0.4);
        }

        .profile-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .profile-avatar {
            font-size: 3em;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-info {
            text-align: left;
        }

        .profile-name {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--secondary);
        }

        .profile-level {
            color: var(--text-light);
        }

        .profile-coins {
            color: #f39c12;
            font-weight: bold;
            font-size: 0.95em;
        }

        /* Leaderboard Styles */
        .leaderboard {
            margin: 15px 0;
        }

        .leaderboard-entry {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            margin: 8px 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            transition: all 0.3s;
        }

        .leaderboard-entry:nth-child(1) {
            background: linear-gradient(135deg, #ffd700 0%, #ffec8b 100%);
        }

        .leaderboard-entry:nth-child(2) {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
        }

        .leaderboard-entry:nth-child(3) {
            background: linear-gradient(135deg, #cd7f32 0%, #daa06d 100%);
        }

        .leaderboard-entry.current-user {
            border: 3px solid var(--secondary);
        }

        .leaderboard-rank {
            font-size: 1.2em;
            font-weight: bold;
            width: 35px;
            color: var(--text);
        }

        .leaderboard-avatar {
            font-size: 1.8em;
            margin-right: 10px;
        }

        .leaderboard-name {
            flex: 1;
            font-weight: bold;
            color: var(--text);
            text-align: left;
        }

        .leaderboard-score {
            font-weight: bold;
            color: var(--secondary);
        }

        .leaderboard-level {
            font-size: 0.8em;
            color: var(--text-light);
            margin-left: 10px;
        }

        .tab-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab-btn {
            padding: 8px 20px;
            border: none;
            background: #eee;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .switch-profile-btn {
            font-size: 0.8em;
            padding: 5px 15px;
            margin-top: 5px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
                border-radius: 20px;
            }

            .title { font-size: 1.6em; }
            .question { font-size: 1.8em; }
            .answer-input { font-size: 1.5em; width: 100px; }
            .badge { width: 40px; height: 40px; font-size: 1.2em; }
            .heatmap { font-size: 0.6em; }
            .start-btn, .mode-btn-large { padding: 12px 30px; font-size: 1.1em; }
            .avatar-grid { grid-template-columns: repeat(5, 1fr); gap: 5px; }
            .avatar-option { font-size: 2em; padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div class="screen active" id="loginScreen">
            <div class="mascot">üåü</div>
            <h1 class="title">Math Stars</h1>
            <p class="subtitle">Multiplikations√§ventyr!</p>

            <div id="existingProfiles" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: var(--secondary); margin: 0;">V√§lj din profil:</h3>
                    <button onclick="loadExistingProfiles()" style="background: none; border: none; font-size: 1.2em; cursor: pointer; padding: 5px;" title="Ladda om profiler">üîÑ</button>
                </div>
                <div id="connectionStatus" style="font-size: 0.8em; color: #888; margin-bottom: 10px;"></div>
                <div id="profileList"></div>
            </div>

            <div id="loginForm">
                <div id="newProfileHeader" style="display: none;">
                    <div style="border-top: 2px solid #eee; margin: 20px 0; padding-top: 20px;">
                        <h3 style="color: var(--text-light); margin-bottom: 10px;">Eller skapa ny profil:</h3>
                    </div>
                </div>
                <h3 style="color: var(--secondary); margin: 10px 0 10px;" id="nameLabel">Vad heter du?</h3>
                <input type="text" class="name-input" id="nameInput" placeholder="Ditt namn..." maxlength="15">
                <p id="nameHint" style="display: none; color: #e74c3c; font-size: 0.85em; margin-top: 5px;"></p>

                <h3 style="color: var(--secondary); margin: 20px 0 10px;">V√§lj din figur!</h3>
                <div class="avatar-grid" id="avatarGrid"></div>

                <button class="start-btn" onclick="createProfile()" id="createProfileBtn" disabled>
                    üöÄ B√∂rja spela!
                </button>
            </div>
        </div>

        <!-- Start Screen -->
        <div class="screen" id="startScreen">
            <div class="profile-header">
                <div class="profile-avatar" id="currentAvatar">ü¶ä</div>
                <div class="profile-info">
                    <div class="profile-name" id="currentName">Spelare</div>
                    <div class="profile-level" id="currentLevel">Niv√• 1</div>
                    <div class="profile-coins">üí∞ <span id="currentCoins">0</span> po√§ng</div>
                    <button class="nav-btn switch-profile-btn" onclick="showScreen('loginScreen'); loadExistingProfiles();">Byt profil</button>
                </div>
            </div>

            <div class="daily-goal">
                <div style="color: #666; font-size: 0.9em;">Dagens framsteg</div>
                <div style="font-size: 1.2em; font-weight: bold; color: #764ba2;" id="dailyProgress">0 / 20 fr√•gor</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="dailyProgressBar" style="width: 0%"></div>
                </div>
            </div>

            <div class="daily-challenge-card" id="dailyChallengeCard">
                <div style="font-weight: bold; color: #764ba2;">üéØ Dagens utmaning</div>
                <div id="dailyChallengeText" style="margin: 5px 0;"></div>
                <button class="nav-btn" onclick="startDailyChallenge()">Starta!</button>
            </div>

            <!-- Math Type Selector -->
            <div class="math-type-selector" style="margin: 15px 0;">
                <div style="color: #666; font-size: 0.9em; margin-bottom: 8px;">V√§lj r√§knes√§tt:</div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                    <button class="math-type-btn active" data-type="multiplication" onclick="selectMathType('multiplication')">‚úñÔ∏è G√•nger</button>
                    <button class="math-type-btn" data-type="addition" onclick="selectMathType('addition')">‚ûï Plus</button>
                    <button class="math-type-btn" data-type="subtraction" onclick="selectMathType('subtraction')">‚ûñ Minus</button>
                    <button class="math-type-btn" data-type="tiokompisar" onclick="selectMathType('tiokompisar')">üîü Tiokompisar</button>
                </div>
                <!-- Difficulty selector for plus/minus -->
                <div id="difficultySelector" style="display: none; margin-top: 10px;">
                    <div style="color: #666; font-size: 0.85em; margin-bottom: 5px;">Sv√•righetsniv√•:</div>
                    <div style="display: flex; gap: 8px; justify-content: center;">
                        <button class="difficulty-btn active" data-diff="easy" onclick="selectDifficulty('easy')">üå± L√§tt (1-10)</button>
                        <button class="difficulty-btn" data-diff="medium" onclick="selectDifficulty('medium')">üåø Medel (1-20)</button>
                        <button class="difficulty-btn" data-diff="hard" onclick="selectDifficulty('hard')">üå≥ Sv√•r (1-100)</button>
                    </div>
                </div>
            </div>

            <button class="start-btn" onclick="startGame('practice')">‚ñ∂Ô∏è √ñva</button>
            <button class="mode-btn-large boss-btn" onclick="showBossSelect()">üêâ Bossutmaning (√ó)</button>

            <!-- Shop Preview Card -->
            <div class="shop-preview" id="shopPreview" onclick="showScreen('settingsScreen'); setTimeout(renderThemeSelector, 100);">
                <div class="shop-preview-header">
                    <span>üé® Skin Shop</span>
                    <span class="shop-preview-arrow">‚Üí</span>
                </div>
                <div class="shop-preview-content" id="shopPreviewContent">
                    <!-- Filled by JavaScript -->
                </div>
            </div>

            <div style="margin-top: 15px;">
                <button class="nav-btn" onclick="showScreen('leaderboardScreen')">üèÜ Topplista</button>
                <button class="nav-btn" onclick="showScreen('statsScreen')">üìä Statistik</button>
                <button class="nav-btn" onclick="showScreen('settingsScreen')">‚öôÔ∏è Inst√§llningar</button>
            </div>
        </div>

        <!-- Leaderboard Screen -->
        <div class="screen" id="leaderboardScreen">
            <h2 class="title">üèÜ Topplista</h2>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showLeaderboardTab('score')">Po√§ng</button>
                <button class="tab-btn" onclick="showLeaderboardTab('level')">Niv√•</button>
                <button class="tab-btn" onclick="showLeaderboardTab('streak')">Svit</button>
            </div>

            <div class="leaderboard" id="leaderboard">
                <p style="color: #888;">Laddar topplista...</p>
            </div>

            <button class="nav-btn" onclick="showScreen('startScreen')">üè† Tillbaka</button>
        </div>

        <!-- Settings Screen -->
        <div class="screen" id="settingsScreen">
            <h2 class="title">‚öôÔ∏è Inst√§llningar</h2>

            <h3 style="margin: 15px 0 10px; color: #666;">V√§lj tabeller att √∂va</h3>
            <div class="table-select" id="tableSelect"></div>

            <h3 style="margin: 15px 0 10px; color: #666;">Ljud</h3>
            <button class="nav-btn" id="soundToggle" onclick="toggleSound()">üîä Ljud p√•</button>

            <h3 style="margin: 20px 0 10px; color: var(--secondary);">üé® Skin Shop</h3>
            <div class="coins-display">
                <span>üí∞</span>
                <span>Dina po√§ng: <span id="shopCoins">0</span></span>
            </div>
            <div class="theme-selector" id="themeSelector"></div>

            <br>
            <button class="nav-btn" onclick="showScreen('startScreen')">üè† Tillbaka</button>
        </div>

        <!-- Stats Screen -->
        <div class="screen" id="statsScreen">
            <h2 class="title">üìä Statistik</h2>

            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="totalCorrectStat">0</div>
                    <div class="stat-label">Totalt r√§tt</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="bestStreakStat">0</div>
                    <div class="stat-label">B√§sta svit</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="levelStat">1</div>
                    <div class="stat-label">Niv√•</div>
                </div>
            </div>

            <h3 style="margin: 15px 0 10px; color: var(--secondary);">Multiplikationskarta</h3>
            <p style="font-size: 0.8em; color: #888; margin-bottom: 10px;">Gr√∂n = kan bra, Gul = l√§r sig, R√∂d = beh√∂ver √∂va</p>
            <div class="heatmap" id="heatmap"></div>

            <div class="achievements-section">
                <div class="achievements-title">üèÜ M√§rken</div>
                <div class="badges-container" id="statsBadges"></div>
            </div>

            <button class="nav-btn" onclick="showScreen('startScreen')">üè† Tillbaka</button>
        </div>

        <!-- Boss Select Screen -->
        <div class="screen" id="bossSelectScreen">
            <h2 class="title">üêâ V√§lj Boss</h2>
            <p style="color: #666; margin-bottom: 15px;">Besegra bossen genom att svara r√§tt!</p>

            <div id="bossOptions"></div>

            <button class="nav-btn" onclick="showScreen('startScreen')">üè† Tillbaka</button>
        </div>

        <!-- Game Screen -->
        <div class="screen" id="gameScreen">
            <div class="level-display">
                <span id="levelText">Niv√• 1</span> - <span id="levelTitle">Nyb√∂rjare</span>
            </div>

            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="score">0</div>
                    <div class="stat-label">Po√§ng</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="correct">0</div>
                    <div class="stat-label">R√§tt</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total">0</div>
                    <div class="stat-label">Totalt</div>
                </div>
            </div>

            <div class="streak-display">
                <span class="streak-fire" id="streakFire">üî•</span>
                <span>Svit: <strong id="streak">0</strong></span>
            </div>

            <div class="smart-indicator" id="smartIndicator">
                üß† Smart √∂vning aktiv
            </div>

            <div id="roundProgress" style="margin: 10px 0; padding: 8px 15px; background: linear-gradient(135deg, #667eea20, #764ba220); border-radius: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <span style="font-weight: bold; color: var(--primary);">Runda <span id="roundNumber">1</span></span>
                    <span style="color: var(--text-light); font-size: 0.9em;">Fr√•ga <span id="questionInRound">1</span>/10</span>
                </div>
                <div style="height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                    <div id="roundProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width 0.3s;"></div>
                </div>
            </div>

            <div class="question-area">
                <div id="bossArea" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div id="playerLives" style="font-size: 1.5em;">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                        <div class="boss-emoji" id="bossEmoji" style="font-size: 2.5em; animation: bossFloat 1s ease-in-out infinite;">üêâ</div>
                        <div style="font-size: 1.2em; color: var(--secondary);" id="bossHpText">10 HP</div>
                    </div>
                    <div class="boss-name" id="bossName">Drake</div>
                    <div class="boss-health-bar">
                        <div class="boss-health-fill" id="bossHealth" style="width: 100%"></div>
                    </div>
                </div>

                <div class="timer-bar" id="timerBar" style="display: none;">
                    <div class="timer-fill" id="timerFill" style="width: 100%"></div>
                </div>

                <div class="question" id="question">5 √ó 7 = ?</div>
                <input type="number" class="answer-input" id="answerInput" inputmode="numeric" pattern="[0-9]*">
                <button class="submit-btn" onclick="checkAnswer()">Kolla! ‚úì</button>
                <div class="feedback" id="feedback"></div>
            </div>

            <div class="tip-box" id="tipBox">
                <div class="tip-title">üí° Tips!</div>
                <div class="tip-content" id="tipContent"></div>
                <button class="tip-continue-btn" onclick="dismissTipAndContinue()">Jag f√∂rst√•r! ‚úì</button>
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" id="xpBar" style="width: 0%"></div>
            </div>
            <div class="encouragement" id="encouragement">Du klarar detta! üí™</div>

            <button class="nav-btn" onclick="endGame()">üè† Hem</button>
        </div>

        <!-- Boss Victory Screen -->
        <div class="screen" id="victoryScreen">
            <div class="mascot">üèÜ</div>
            <h1 class="title">SEGER!</h1>
            <p class="subtitle" id="victoryText">Du besegrade bossen!</p>

            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="victoryScore">0</div>
                    <div class="stat-label">Po√§ng</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="victoryTime">0s</div>
                    <div class="stat-label">Tid</div>
                </div>
            </div>

            <button class="start-btn" onclick="showScreen('startScreen')">üè† Hem</button>
        </div>

        <!-- Boss Defeat Screen -->
        <div class="screen" id="defeatScreen">
            <div class="mascot">üíÄ</div>
            <h1 class="title" style="background: linear-gradient(135deg, #e17055, #d63031); -webkit-background-clip: text;">GAME OVER</h1>
            <p class="subtitle" id="defeatText">Bossen vann denna g√•ng...</p>
            <p style="color: #888; margin: 15px 0;">men ge inte upp! f√∂rs√∂k igen üí™</p>

            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="defeatBossHp">5</div>
                    <div class="stat-label">Boss HP kvar</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="defeatScore">0</div>
                    <div class="stat-label">Po√§ng</div>
                </div>
            </div>

            <button class="start-btn boss-btn" onclick="retryBoss()">üîÑ F√∂rs√∂k igen</button>
            <button class="nav-btn" onclick="showScreen('startScreen')">üè† Hem</button>
        </div>

        <!-- Round Complete Screen -->
        <div class="screen" id="roundCompleteScreen">
            <div class="mascot">üéâ</div>
            <h1 class="title">RUNDA KLAR!</h1>
            <p class="subtitle" id="roundCompleteText">Runda 1 avklarad!</p>

            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="roundCorrect">0</div>
                    <div class="stat-label">R√§tt</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="roundAccuracy">0%</div>
                    <div class="stat-label">Tr√§ffs√§kerhet</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="roundPoints">0</div>
                    <div class="stat-label">Po√§ng</div>
                </div>
            </div>

            <p id="roundMessage" style="font-size: 1.2em; margin: 15px 0; color: var(--secondary);"></p>

            <button class="start-btn" onclick="startNextRound()">‚ñ∂Ô∏è N√§sta runda</button>
            <button class="nav-btn" onclick="showScreen('startScreen')">üè† Hem</button>
        </div>
    </div>

    <div class="celebration" id="celebration"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ==================== FIREBASE CONFIG ====================
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA2wxpX1TGFa6oQubwHfFKcU7qcdsujCGU",
            authDomain: "math-stars-1c848.firebaseapp.com",
            databaseURL: "https://math-stars-1c848-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "math-stars-1c848",
            storageBucket: "math-stars-1c848.firebasestorage.app",
            messagingSenderId: "730094278595",
            appId: "1:730094278595:web:ec6877dfe6cbda8efd8f76"
        };

        let firebaseEnabled = false;
        let database = null;

        // Initialize Firebase (only if configured)
        function initFirebase() {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                try {
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    firebaseEnabled = true;
                    console.log("Firebase connected!");
                } catch (e) {
                    console.log("Firebase not configured, using local storage only");
                }
            }
        }

        // ==================== AVATARS ====================
        const avatars = ['ü¶ä', 'üê±', 'üê∂', 'üê∞', 'üêº', 'ü¶Å', 'üê∏', 'ü¶ã', 'üå∏', '‚≠ê', 'üåà', 'ü¶Ñ', 'üê¨', 'ü¶©', 'üêù', 'üíÄ', 'üëΩ', 'ü§ñ', 'üëª', 'üî•'];

        let selectedAvatar = null;
        let currentProfile = null;

        // ==================== MATH TYPE SETTINGS ====================
        let currentMathType = 'multiplication'; // multiplication, addition, subtraction, tiokompisar
        let currentDifficulty = 'easy'; // easy, medium, hard

        function selectMathType(type) {
            currentMathType = type;
            document.querySelectorAll('.math-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });

            // Show/hide difficulty selector for plus/minus
            const diffSelector = document.getElementById('difficultySelector');
            if (type === 'addition' || type === 'subtraction') {
                diffSelector.style.display = 'block';
            } else {
                diffSelector.style.display = 'none';
            }
        }

        function selectDifficulty(diff) {
            currentDifficulty = diff;
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.diff === diff);
            });
        }

        function getDifficultyRange() {
            switch (currentDifficulty) {
                case 'easy': return { min: 1, max: 10 };
                case 'medium': return { min: 1, max: 20 };
                case 'hard': return { min: 1, max: 100 };
                default: return { min: 1, max: 10 };
            }
        }

        // ==================== PROFILE SYSTEM ====================
        function renderAvatarGrid() {
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = '';

            avatars.forEach(avatar => {
                const div = document.createElement('div');
                div.className = 'avatar-option';
                div.textContent = avatar;
                div.onclick = () => selectAvatar(avatar, div);
                grid.appendChild(div);
            });
        }

        function selectAvatar(avatar, element) {
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedAvatar = avatar;
            checkCanCreate();
        }

        // Only allow letters (including Swedish √•, √§, √∂) and spaces
        function isValidName(name) {
            // Must be 2-15 characters, only letters and spaces
            const nameRegex = /^[a-zA-Z√•√§√∂√Ö√Ñ√ñ√©√â√º√ú][a-zA-Z√•√§√∂√Ö√Ñ√ñ√©√â√º√ú\s]{1,14}$/;
            if (!nameRegex.test(name)) return false;

            // Basic blocklist for inappropriate words
            const blocklist = ['admin', 'test', 'fuck', 'shit', 'dick', 'ass', 'sex', 'porn', 'nazi', 'hitler'];
            const lowerName = name.toLowerCase();
            if (blocklist.some(word => lowerName.includes(word))) return false;

            return true;
        }

        function checkCanCreate() {
            const name = document.getElementById('nameInput').value.trim();
            const btn = document.getElementById('createProfileBtn');
            const isValid = name.length >= 2 && selectedAvatar && isValidName(name);
            btn.disabled = !isValid;

            // Show hint if name is invalid
            const hint = document.getElementById('nameHint');
            if (hint) {
                if (name.length >= 2 && !isValidName(name)) {
                    hint.textContent = 'Anv√§nd bara bokst√§ver (inga siffror eller symboler)';
                    hint.style.display = 'block';
                } else {
                    hint.style.display = 'none';
                }
            }
        }

        async function createProfile() {
            const name = document.getElementById('nameInput').value.trim().toLowerCase();
            const displayName = document.getElementById('nameInput').value.trim();
            if (!displayName || !selectedAvatar || !isValidName(displayName)) return;

            const btn = document.getElementById('createProfileBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Skapar...';

            try {
                // Check if name + avatar combination already exists in Firebase
                const snapshot = await database.ref('leaderboard').once('value');
                const profilesData = snapshot.val() || {};
                const existingProfiles = Object.values(profilesData).filter(p => p && p.name);

                // Check for duplicate name + avatar combination
                const nameLower = name.toLowerCase();
                const duplicateWithSameAvatar = existingProfiles.some(p =>
                    p.name && p.name.toLowerCase() === nameLower && p.avatar === selectedAvatar
                );
                if (duplicateWithSameAvatar) {
                    alert('Det finns redan en profil med det namnet och den figuren! V√§lj en annan figur eller ett annat namn.');
                    btn.disabled = false;
                    btn.textContent = 'üöÄ B√∂rja spela!';
                    return;
                }

                const profileId = 'profile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const profile = {
                    id: profileId,
                    name: displayName,
                    nameLower: name,
                    avatar: selectedAvatar,
                    createdAt: Date.now()
                };

                // Save profile to Firebase under leaderboard
                await database.ref('leaderboard/' + profileId).set(profile);

                // Also cache locally
                let profiles = JSON.parse(localStorage.getItem('mathStarsProfiles') || '[]');
                profiles.push(profile);
                localStorage.setItem('mathStarsProfiles', JSON.stringify(profiles));

                // Set as current profile
                localStorage.setItem('mathStarsCurrentProfile', profileId);

                // Initialize game state for this profile
                currentProfile = profile;
                initializeGameStateForProfile(profileId);

                // Go to main screen
                updateProfileDisplay();
                showScreen('startScreen');
            } catch (error) {
                console.error('Error creating profile:', error);
                alert('Kunde inte skapa profil. Kontrollera din internetanslutning.');
                btn.disabled = false;
                btn.textContent = 'üöÄ B√∂rja spela!';
            }
        }

        async function initializeGameStateForProfile(profileId) {
            // Check Firebase first, then localStorage
            try {
                const snapshot = await database.ref('gameStates/' + profileId).once('value');
                if (snapshot.exists()) {
                    gameState = { ...getDefaultGameState(), ...snapshot.val() };
                    const factsSnapshot = await database.ref('factStats/' + profileId).once('value');
                    if (factsSnapshot.exists()) {
                        factStats = factsSnapshot.val();
                    }
                    // Update localStorage cache
                    localStorage.setItem(`mathStars_${profileId}_state`, JSON.stringify(gameState));
                    localStorage.setItem(`mathStars_${profileId}_facts`, JSON.stringify(factStats));
                    return;
                }
            } catch (error) {
                console.error('Firebase load error:', error);
            }

            // Fallback to localStorage
            const existingState = localStorage.getItem(`mathStars_${profileId}_state`);
            if (!existingState) {
                // New profile - initialize fresh state
                gameState = getDefaultGameState();
                factStats = {};
                saveGameState();
            } else {
                await loadGameState();
            }
        }

        function getDefaultGameState() {
            return {
                score: 0,
                correct: 0,
                total: 0,
                streak: 0,
                bestStreak: 0,
                level: 1,
                xp: 0,
                xpToNext: 100,
                totalScore: 0,
                selectedTables: [2, 3, 4, 5],
                mode: 'practice',
                dailyQuestions: 0,
                dailyGoal: 20,
                lastPlayDate: null,
                totalCorrect: 0,
                achievements: {},
                masteredTables: [],
                currentTheme: 'default',
                unlockedThemes: ['default'],
                soundEnabled: true,
                bossesDefeated: [],
                dailyChallengeCompleted: false
            };
        }

        async function loadExistingProfiles() {
            const container = document.getElementById('existingProfiles');
            const list = document.getElementById('profileList');
            const newProfileHeader = document.getElementById('newProfileHeader');
            const statusEl = document.getElementById('connectionStatus');

            list.innerHTML = '<p style="color: #888; text-align: center;">Laddar profiler...</p>';
            container.style.display = 'block';
            statusEl.innerHTML = '‚è≥ Ansluter...';

            // Check if Firebase is available
            if (!firebaseEnabled || !database) {
                console.log('Firebase not available, using local storage');
                statusEl.innerHTML = 'üì± Endast lokal lagring (Firebase ej ansluten)';
                statusEl.style.color = '#e74c3c';
                loadProfilesFromLocalStorage();
                return;
            }

            try {
                // Load profiles from Firebase (stored under /leaderboard/)
                const snapshot = await database.ref('leaderboard').once('value');
                const profilesData = snapshot.val() || {};

                let profiles = Object.values(profilesData).filter(p => p && p.id && p.name);

                const firebaseProfileIds = new Set(profiles.map(p => p.id));

                // Check for local profiles that need to be migrated to Firebase
                const localProfiles = JSON.parse(localStorage.getItem('mathStarsProfiles') || '[]');
                const profilesToMigrate = localProfiles.filter(p => !firebaseProfileIds.has(p.id));

                if (profilesToMigrate.length > 0) {
                    console.log('Migrating', profilesToMigrate.length, 'local profiles to Firebase');
                    statusEl.innerHTML = '‚¨ÜÔ∏è Laddar upp ' + profilesToMigrate.length + ' profiler till molnet...';

                    for (const profile of profilesToMigrate) {
                        try {
                            // Save to leaderboard path
                            await database.ref('leaderboard/' + profile.id).set(profile);

                            // Also migrate game state if it exists locally
                            const localState = localStorage.getItem(`mathStars_${profile.id}_state`);
                            if (localState) {
                                await database.ref('gameStates/' + profile.id).set(JSON.parse(localState));
                            }

                            profiles.push(profile);
                            console.log('Migrated profile:', profile.name);
                        } catch (e) {
                            console.error('Failed to migrate profile:', profile.name, e);
                        }
                    }
                }

                console.log('Loaded', profiles.length, 'profiles from Firebase');
                statusEl.innerHTML = '‚òÅÔ∏è Ansluten till molnet (' + profiles.length + ' profiler)';
                statusEl.style.color = '#27ae60';

                // Update local cache with all profiles
                localStorage.setItem('mathStarsProfiles', JSON.stringify(profiles));

                if (profiles.length === 0) {
                    container.style.display = 'none';
                    newProfileHeader.style.display = 'none';
                    return;
                }

                newProfileHeader.style.display = 'block';
                list.innerHTML = '';

                // Load game states from Firebase for each profile
                const statesSnapshot = await database.ref('gameStates').once('value');
                const allStates = statesSnapshot.val() || {};

                profiles.forEach(profile => {
                    const state = allStates[profile.id] || { level: 1, totalScore: 0 };

                    const div = document.createElement('div');
                    div.className = 'leaderboard-entry';
                    div.style.cursor = 'pointer';
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'space-between';
                    div.innerHTML = `
                        <div onclick="selectExistingProfile(${JSON.stringify(profile).replace(/"/g, '&quot;')})" style="flex: 1; display: flex; align-items: center; gap: 10px;">
                            <span class="leaderboard-avatar">${profile.avatar}</span>
                            <span class="leaderboard-name">${profile.name}</span>
                            <span class="leaderboard-level">Niv√• ${state.level || 1} ‚Ä¢ üí∞ ${state.totalScore || 0}</span>
                        </div>
                        <button onclick="event.stopPropagation(); deleteProfile('${profile.id}', '${profile.name}')" style="background: none; border: none; font-size: 1em; cursor: pointer; padding: 5px; opacity: 0.5;" title="Ta bort profil">üóëÔ∏è</button>
                    `;
                    list.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading profiles from Firebase:', error);
                const statusEl = document.getElementById('connectionStatus');
                statusEl.innerHTML = '‚ö†Ô∏è Kunde inte ansluta till molnet';
                statusEl.style.color = '#e74c3c';
                loadProfilesFromLocalStorage();
            }
        }

        function loadProfilesFromLocalStorage() {
            const container = document.getElementById('existingProfiles');
            const list = document.getElementById('profileList');
            const newProfileHeader = document.getElementById('newProfileHeader');

            const profiles = JSON.parse(localStorage.getItem('mathStarsProfiles') || '[]');
            if (profiles.length === 0) {
                container.style.display = 'none';
                newProfileHeader.style.display = 'none';
                list.innerHTML = '';
                return;
            }

            container.style.display = 'block';
            newProfileHeader.style.display = 'block';
            list.innerHTML = '';

            profiles.forEach(profile => {
                const savedState = localStorage.getItem(`mathStars_${profile.id}_state`);
                const state = savedState ? JSON.parse(savedState) : { level: 1, totalScore: 0 };

                const div = document.createElement('div');
                div.className = 'leaderboard-entry';
                div.style.cursor = 'pointer';
                div.innerHTML = `
                    <span class="leaderboard-avatar">${profile.avatar}</span>
                    <span class="leaderboard-name">${profile.name}</span>
                    <span class="leaderboard-level">Niv√• ${state.level} ‚Ä¢ üí∞ ${state.totalScore}</span>
                `;
                div.onclick = () => selectExistingProfile(profile);
                list.appendChild(div);
            });
        }

        async function selectExistingProfile(profile) {
            currentProfile = profile;
            localStorage.setItem('mathStarsCurrentProfile', profile.id);
            await initializeGameStateForProfile(profile.id);
            initFactStats();
            checkDailyReset();
            applyTheme(gameState.currentTheme);
            setupTableSelect();
            renderThemeSelector();
            updateDailyProgress();
            updateDailyChallengeCard();
            document.getElementById('soundToggle').textContent = gameState.soundEnabled ? 'üîä Ljud p√•' : 'üîá Ljud av';
            updateProfileDisplay();
            showScreen('startScreen');
        }

        async function deleteProfile(profileId, profileName) {
            if (!confirm(`Vill du verkligen ta bort profilen "${profileName}"? Detta g√•r inte att √•ngra!`)) {
                return;
            }

            try {
                // Delete from Firebase
                if (firebaseEnabled && database) {
                    await database.ref('leaderboard/' + profileId).remove();
                    await database.ref('gameStates/' + profileId).remove();
                    await database.ref('factStats/' + profileId).remove();
                }

                // Delete from local storage
                let profiles = JSON.parse(localStorage.getItem('mathStarsProfiles') || '[]');
                profiles = profiles.filter(p => p.id !== profileId);
                localStorage.setItem('mathStarsProfiles', JSON.stringify(profiles));
                localStorage.removeItem(`mathStars_${profileId}_state`);
                localStorage.removeItem(`mathStars_${profileId}_factStats`);

                // If this was the current profile, clear it
                if (localStorage.getItem('mathStarsCurrentProfile') === profileId) {
                    localStorage.removeItem('mathStarsCurrentProfile');
                    currentProfile = null;
                }

                // Reload profile list
                loadExistingProfiles();
            } catch (error) {
                console.error('Error deleting profile:', error);
                alert('Kunde inte ta bort profilen. F√∂rs√∂k igen.');
            }
        }

        function updateProfileDisplay() {
            if (!currentProfile) return;

            document.getElementById('currentAvatar').textContent = currentProfile.avatar;
            document.getElementById('currentName').textContent = currentProfile.name;
            document.getElementById('currentLevel').textContent = `Niv√• ${gameState.level}`;
            document.getElementById('currentCoins').textContent = gameState.totalScore;
        }

        function loadCurrentProfile() {
            const currentProfileId = localStorage.getItem('mathStarsCurrentProfile');
            const profiles = JSON.parse(localStorage.getItem('mathStarsProfiles') || '[]');

            if (currentProfileId) {
                currentProfile = profiles.find(p => p.id === currentProfileId);
                if (currentProfile) {
                    initializeGameStateForProfile(currentProfileId);
                    updateProfileDisplay();
                    return true;
                }
            }
            return false;
        }

        // ==================== LEADERBOARD ====================
        let currentLeaderboardTab = 'score';

        function showLeaderboardTab(tab) {
            currentLeaderboardTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadLeaderboard();
        }

        function loadLeaderboard() {
            const container = document.getElementById('leaderboard');

            if (firebaseEnabled) {
                loadLeaderboardFromFirebase();
            } else {
                loadLeaderboardFromLocal();
            }
        }

        function loadLeaderboardFromLocal() {
            const container = document.getElementById('leaderboard');
            const profiles = JSON.parse(localStorage.getItem('mathStarsProfiles') || '[]');

            // Get stats for each profile
            const leaderboardData = profiles.map(profile => {
                const stateKey = `mathStars_${profile.id}_state`;
                const state = JSON.parse(localStorage.getItem(stateKey) || '{}');
                return {
                    ...profile,
                    totalScore: state.totalScore || 0,
                    level: state.level || 1,
                    bestStreak: state.bestStreak || 0
                };
            });

            // Sort based on current tab
            if (currentLeaderboardTab === 'score') {
                leaderboardData.sort((a, b) => b.totalScore - a.totalScore);
            } else if (currentLeaderboardTab === 'level') {
                leaderboardData.sort((a, b) => b.level - a.level);
            } else {
                leaderboardData.sort((a, b) => b.bestStreak - a.bestStreak);
            }

            renderLeaderboard(leaderboardData);
        }

        function loadLeaderboardFromFirebase() {
            const container = document.getElementById('leaderboard');
            container.innerHTML = '<p style="color: #888;">Laddar topplista...</p>';

            const sortField = currentLeaderboardTab === 'score' ? 'totalScore' :
                              currentLeaderboardTab === 'level' ? 'level' : 'bestStreak';

            database.ref('leaderboard').orderByChild(sortField).limitToLast(20).once('value')
                .then(snapshot => {
                    const data = [];
                    snapshot.forEach(child => {
                        data.push(child.val());
                    });
                    data.reverse(); // Highest first
                    renderLeaderboard(data);
                })
                .catch(err => {
                    console.error('Leaderboard error:', err);
                    loadLeaderboardFromLocal();
                });
        }

        function renderLeaderboard(data) {
            const container = document.getElementById('leaderboard');

            if (data.length === 0) {
                container.innerHTML = '<p style="color: #888;">Inga spelare √§nnu. Var f√∂rst!</p>';
                return;
            }

            container.innerHTML = '';

            data.forEach((player, index) => {
                const isCurrentUser = currentProfile && player.id === currentProfile.id;
                const div = document.createElement('div');
                div.className = `leaderboard-entry ${isCurrentUser ? 'current-user' : ''}`;

                const value = currentLeaderboardTab === 'score' ? player.totalScore :
                              currentLeaderboardTab === 'level' ? player.level : player.bestStreak;

                const label = currentLeaderboardTab === 'score' ? 'p' :
                              currentLeaderboardTab === 'level' ? '' : 'üî•';

                div.innerHTML = `
                    <span class="leaderboard-rank">${index + 1}.</span>
                    <span class="leaderboard-avatar">${player.avatar}</span>
                    <span class="leaderboard-name">${player.name}</span>
                    <span class="leaderboard-score">${value}${label}</span>
                `;
                container.appendChild(div);
            });
        }

        function updateLeaderboard() {
            if (!firebaseEnabled || !currentProfile) return;

            const leaderboardEntry = {
                id: currentProfile.id,
                name: currentProfile.name,
                avatar: currentProfile.avatar,
                totalScore: gameState.totalScore,
                level: gameState.level,
                bestStreak: gameState.bestStreak,
                updatedAt: Date.now()
            };

            database.ref('leaderboard/' + currentProfile.id).set(leaderboardEntry)
                .catch(err => console.error('Update leaderboard error:', err));
        }

        // ==================== GAME STATE ====================
        let gameState = {
            score: 0,
            correct: 0,
            total: 0,
            streak: 0,
            bestStreak: 0,
            level: 1,
            xp: 0,
            xpToNext: 100,
            totalScore: 0,
            selectedTables: [2, 3, 4, 5],
            mode: 'practice',
            dailyQuestions: 0,
            dailyGoal: 20,
            lastPlayDate: null,
            totalCorrect: 0,
            achievements: {},
            masteredTables: [],
            currentTheme: 'default',
            unlockedThemes: ['default'],
            soundEnabled: true,
            bossesDefeated: [],
            dailyChallengeCompleted: false
        };

        let factStats = {};

        function initFactStats() {
            for (let i = 1; i <= 10; i++) {
                for (let j = 1; j <= 10; j++) {
                    const key = `${i}x${j}`;
                    if (!factStats[key]) {
                        factStats[key] = {
                            correct: 0,
                            wrong: 0,
                            totalTime: 0,
                            attempts: 0,
                            lastPracticed: null,
                            streak: 0
                        };
                    }
                }
            }
        }

        // ==================== SMART ALGORITHM ====================
        let lastQuestionKey = null; // Track last question to avoid repeats

        function getFactScore(key) {
            const stat = factStats[key];

            // Never practiced? High priority (low score = more likely to be picked)
            if (!stat || stat.attempts === 0) return -1;

            const accuracy = stat.correct / stat.attempts;
            const avgTime = stat.totalTime / stat.attempts;
            const timeFactor = Math.min(avgTime / 3000, 2);
            const daysSincePractice = stat.lastPracticed
                ? (Date.now() - stat.lastPracticed) / (1000 * 60 * 60 * 24)
                : 7;
            const recencyFactor = Math.min(daysSincePractice / 7, 1);

            // Wrong streak penalty - if they keep getting it wrong, prioritize it
            const wrongStreakPenalty = stat.streak < 0 ? Math.abs(stat.streak) * 0.2 : 0;

            // Base score: higher = better known, lower = needs more practice
            return accuracy * 0.4 - timeFactor * 0.2 - recencyFactor * 0.2 - wrongStreakPenalty;
        }

        function selectSmartQuestion() {
            const candidates = [];

            for (const table of gameState.selectedTables) {
                for (let j = 1; j <= 10; j++) {
                    const key = `${table}x${j}`;
                    // Skip the last question to ensure variety
                    if (key === lastQuestionKey) continue;

                    candidates.push({
                        num1: table,
                        num2: j,
                        key: key,
                        score: getFactScore(key)
                    });
                }
            }

            // Sort by score (lowest = needs most practice)
            candidates.sort((a, b) => a.score - b.score);

            // Find unpracticed facts (score = -1)
            const unpracticed = candidates.filter(c => c.score === -1);

            // 30% chance to pick an unpracticed fact if any exist
            if (unpracticed.length > 0 && Math.random() < 0.3) {
                const pick = unpracticed[Math.floor(Math.random() * unpracticed.length)];
                lastQuestionKey = pick.key;
                return pick;
            }

            // Take weak pool (30% of candidates that need most practice)
            const poolSize = Math.max(3, Math.floor(candidates.length * 0.3));
            const pool = candidates.slice(0, poolSize);

            // 20% random from all (to keep variety)
            if (Math.random() < 0.2) {
                const pick = candidates[Math.floor(Math.random() * candidates.length)];
                lastQuestionKey = pick.key;
                return pick;
            }

            // 80% from weak pool
            const pick = pool[Math.floor(Math.random() * pool.length)];
            lastQuestionKey = pick.key;
            return pick;
        }

        // ==================== TIPS SYSTEM ====================
        const multiplicationTips = {
            '1': { general: "Allt g√•nger 1 √§r sig sj√§lvt! üéØ", examples: ["7 √ó 1 = 7", "1 √ó 9 = 9"] },
            '2': { general: "Dubbla talet! L√§gg ihop talet med sig sj√§lvt. ‚úåÔ∏è", examples: ["2 √ó 6 = 6 + 6 = 12", "2 √ó 8 = 8 + 8 = 16"] },
            '3': { general: "Dubbla och l√§gg till en g√•ng till! üî¢", examples: ["3 √ó 4 = (2 √ó 4) + 4 = 8 + 4 = 12"] },
            '4': { general: "Dubbla tv√• g√•nger! F√∂rst √ó 2, sen √ó 2 igen. üé≤", examples: ["4 √ó 6 = 2 √ó 6 √ó 2 = 12 √ó 2 = 24"] },
            '5': { general: "H√§lften av 10-g√•ngern! Eller: slutar alltid p√• 0 eller 5. ‚úã", examples: ["5 √ó 6 = (10 √ó 6) √∑ 2 = 30"] },
            '6': { general: "3-g√•ngern dubblad! Eller 5-g√•ngern + en g√•ng till. üéØ", examples: ["6 √ó 4 = (3 √ó 4) √ó 2 = 24"] },
            '7': { general: "Knepig! Prova 5-g√•ngern + 2-g√•ngern. üåü", examples: ["7 √ó 6 = (5 √ó 6) + (2 √ó 6) = 42"] },
            '8': { general: "Dubbla tre g√•nger! 2 √ó 2 √ó 2 = 8. üöÄ", examples: ["8 √ó 6 = 2√ó2√ó2√ó6 = 48"] },
            '9': { general: "Fingertricket! üñêÔ∏è Eller: (10 √ó talet) - talet", examples: ["9 √ó 7 = (10 √ó 7) - 7 = 63"], special: "Fingertrick: H√•ll upp 10 fingrar. F√∂r 9√óN, b√∂j finger N. V√§nster = tiotal, h√∂ger = ental!" },
            '10': { general: "L√§gg till en nolla! Superenkelt! üîü", examples: ["10 √ó 7 = 70"] }
        };

        function getTipForQuestion(num1, num2) {
            const tipNum = Math.max(num1, num2).toString();
            const tip = multiplicationTips[tipNum];
            if (!tip) return null;

            let content = `<strong>${tip.general}</strong><br><br>`;
            content += `Exempel: ${tip.examples.join('<br>')}`;
            if (tip.special) content += `<br><br>üåü ${tip.special}`;
            content += `<br><br>S√•: <strong>${num1} √ó ${num2} = ${num1 * num2}</strong>`;

            return content;
        }

        // ==================== THEMES ====================
        const themes = {
            default: { name: 'Standard', cost: 0, mascot: 'üåü', vibe: 'chill', desc: 'Klassisk och fin!', rarity: 'common' },
            space: { name: 'Rymd', cost: 2000, mascot: 'üëΩ', vibe: 'alien', desc: 'Utforska galaxen!', rarity: 'uncommon' },
            ocean: { name: 'Hav', cost: 2000, mascot: 'üê¨', vibe: 'wave', desc: 'Dyk ner i djupet!', rarity: 'uncommon' },
            forest: { name: 'Skog', cost: 3000, mascot: 'üçÑ', vibe: 'nature', desc: 'Mysigt i skogen!', rarity: 'rare' },
            unicorn: { name: 'Enh√∂rning', cost: 5000, mascot: 'ü¶Ñ', vibe: 'sparkle', desc: 'Magiskt och glittrigt!', rarity: 'epic' },
            skull: { name: 'Skelett', cost: 7500, mascot: 'üíÄ', vibe: 'spooky', desc: 'Lite l√§skigt och kul! üéÉ', rarity: 'legendary' },
            goat: { name: 'M√§stare', cost: 10000, mascot: 'üêê', vibe: 'champion', desc: 'F√∂r riktiga m√§stare! üèÜ', rarity: 'mythic' }
        };

        function applyTheme(themeName) {
            document.body.className = themeName === 'default' ? '' : `theme-${themeName}`;
            gameState.currentTheme = themeName;
            saveGameState();
        }

        function renderThemeSelector() {
            const container = document.getElementById('themeSelector');
            container.innerHTML = '';

            // Update coins display
            document.getElementById('shopCoins').textContent = gameState.totalScore;

            for (const [key, theme] of Object.entries(themes)) {
                const isUnlocked = gameState.unlockedThemes.includes(key);
                const isSelected = gameState.currentTheme === key;
                const progress = Math.min(100, (gameState.totalScore / theme.cost) * 100);
                const canAfford = gameState.totalScore >= theme.cost;

                const card = document.createElement('div');
                card.className = `skin-card${isSelected ? ' selected' : ''}${!isUnlocked ? ' locked' : ''}`;

                // Badge (EQUIPPED or OWNED)
                let badgeHTML = '';
                if (isSelected) {
                    badgeHTML = '<span class="skin-badge badge-equipped">EQUIPPED</span>';
                } else if (isUnlocked) {
                    badgeHTML = '<span class="skin-badge badge-owned">OWNED</span>';
                }

                // Progress bar color based on rarity
                const rarityColors = {
                    common: '#636e72',
                    uncommon: '#00b894',
                    rare: '#0984e3',
                    epic: '#6c5ce7',
                    legendary: '#fdcb6e',
                    mythic: 'linear-gradient(90deg, #fd79a8, #a29bfe, #74b9ff)'
                };
                const progressColor = rarityColors[theme.rarity] || '#667eea';

                card.innerHTML = `
                    ${badgeHTML}
                    <div class="skin-mascot theme-${key}">${theme.mascot}</div>
                    <div class="skin-info">
                        <div class="skin-header">
                            <span class="skin-name">${theme.name}</span>
                            <span class="skin-rarity rarity-${theme.rarity}">${theme.rarity}</span>
                        </div>
                        <div class="skin-desc">${theme.desc}</div>
                        ${!isUnlocked ? `
                            <div class="skin-progress">
                                <div class="skin-progress-fill" style="width: ${progress}%; background: ${progressColor};"></div>
                            </div>
                            <div class="skin-cost">${canAfford ? '‚úÖ Klicka f√∂r att l√•sa upp!' : `${gameState.totalScore} / ${theme.cost} po√§ng`}</div>
                        ` : ''}
                    </div>
                `;

                card.onclick = () => {
                    if (isUnlocked) {
                        applyTheme(key);
                        renderThemeSelector();
                    } else if (canAfford) {
                        gameState.unlockedThemes.push(key);
                        gameState.totalScore -= theme.cost;
                        applyTheme(key);
                        playSound('levelup');
                        createConfetti();
                        renderThemeSelector();
                        saveGameState();
                    }
                };

                container.appendChild(card);
            }
        }

        function updateShopPreview() {
            const container = document.getElementById('shopPreviewContent');
            if (!container) return;

            // Find the next skin to unlock (cheapest one not owned)
            const lockedThemes = Object.entries(themes)
                .filter(([key]) => !gameState.unlockedThemes.includes(key))
                .sort((a, b) => a[1].cost - b[1].cost);

            if (lockedThemes.length === 0) {
                // All skins unlocked!
                container.innerHTML = `
                    <div class="shop-preview-mascot">üéâ</div>
                    <div class="shop-preview-info">
                        <div class="shop-preview-name">Alla skins uppl√•sta!</div>
                        <div class="shop-preview-cost">Du har samlat alla ${Object.keys(themes).length} skins!</div>
                    </div>
                `;
                return;
            }

            const [nextKey, nextTheme] = lockedThemes[0];
            const progress = Math.min(100, (gameState.totalScore / nextTheme.cost) * 100);
            const remaining = Math.max(0, nextTheme.cost - gameState.totalScore);

            container.innerHTML = `
                <div class="shop-preview-mascot">${nextTheme.mascot}</div>
                <div class="shop-preview-info">
                    <div class="shop-preview-name">${nextTheme.name} (${nextTheme.rarity})</div>
                    <div class="shop-preview-progress">
                        <div class="shop-preview-fill" style="width: ${progress}%"></div>
                    </div>
                    <div class="shop-preview-cost">${remaining > 0 ? `${remaining} po√§ng kvar!` : '‚úÖ Kan l√•sas upp!'}</div>
                </div>
            `;
        }

        // ==================== BOSSES ====================
        const bosses = [
            { id: 'dragon', name: 'Drake', emoji: 'üêâ', health: 10, tables: [2, 3], unlocked: true },
            { id: 'wizard', name: 'Trollkarl', emoji: 'üßô', health: 12, tables: [4, 5], unlocked: true },
            { id: 'robot', name: 'Robot', emoji: 'ü§ñ', health: 15, tables: [6, 7], requirement: 'level5' },
            { id: 'alien', name: 'Utomjording', emoji: 'üëΩ', health: 18, tables: [8, 9], requirement: 'level8' },
            { id: 'phoenix', name: 'Fenix', emoji: 'üî•', health: 20, tables: [1,2,3,4,5,6,7,8,9,10], requirement: 'level10', smart: true }
        ];

        let currentBoss = null;
        let bossHealth = 0;
        let bossStartTime = 0;
        let timerInterval = null;
        let playerLives = 3;

        // Round system for practice mode
        const QUESTIONS_PER_ROUND = 10;
        let currentRound = 1;
        let questionsThisRound = 0;

        function isBossUnlocked(boss) {
            if (boss.unlocked) return true;
            if (boss.requirement === 'level5') return gameState.level >= 5;
            if (boss.requirement === 'level8') return gameState.level >= 8;
            if (boss.requirement === 'level10') return gameState.level >= 10;
            return false;
        }

        function showBossSelect() {
            const container = document.getElementById('bossOptions');
            container.innerHTML = '';

            bosses.forEach(boss => {
                const unlocked = isBossUnlocked(boss);
                const defeated = gameState.bossesDefeated.includes(boss.id);

                const card = document.createElement('div');
                card.style.cssText = `
                    background: ${unlocked ? 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' : '#ddd'};
                    border-radius: 15px; padding: 15px; margin: 10px 0;
                    opacity: ${unlocked ? 1 : 0.5}; cursor: ${unlocked ? 'pointer' : 'not-allowed'};
                `;
                // Format tables nicely
                let tablesText;
                if (boss.smart) {
                    tablesText = 'üß† Dina svagaste tal!';
                } else if (boss.tables.length === 10) {
                    tablesText = 'Alla tabeller (1-10)';
                } else {
                    tablesText = boss.tables.map(t => t + ':ans').join(' och ') + ' tabell';
                }

                card.innerHTML = `
                    <div style="font-size: 2em;">${boss.emoji}</div>
                    <div style="font-weight: bold; color: #764ba2;">${boss.name}</div>
                    <div style="font-size: 0.8em; color: #666;">
                        ${unlocked ? `‚ù§Ô∏è ${boss.health} HP | ${tablesText}` : 'üîí L√•s upp p√• h√∂gre niv√•'}
                    </div>
                    ${defeated ? '<div style="color: #00b894; font-size: 0.9em;">‚úì Besegrad!</div>' : ''}
                `;
                if (unlocked) card.onclick = () => startBossBattle(boss);
                container.appendChild(card);
            });

            showScreen('bossSelectScreen');
        }

        function startBossBattle(boss) {
            currentBoss = boss;
            bossHealth = boss.health;
            bossStartTime = Date.now();
            playerLives = 3;
            gameState.selectedTables = boss.tables;
            gameState.mode = 'boss';

            document.getElementById('bossArea').style.display = 'block';
            document.getElementById('bossEmoji').textContent = boss.emoji;
            document.getElementById('bossName').textContent = boss.name;
            document.getElementById('bossHealth').style.width = '100%';
            document.getElementById('bossHpText').textContent = boss.health + ' HP';
            document.getElementById('playerLives').textContent = '‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è';
            document.getElementById('timerBar').style.display = 'block';
            document.getElementById('smartIndicator').style.display = 'none';

            startGame('boss');
        }

        function retryBoss() {
            if (currentBoss) {
                startBossBattle(currentBoss);
            } else {
                showScreen('bossSelectScreen');
            }
        }

        function updatePlayerLives() {
            const hearts = '‚ù§Ô∏è'.repeat(playerLives) + 'üñ§'.repeat(3 - playerLives);
            document.getElementById('playerLives').textContent = hearts;

            if (playerLives <= 0) {
                // Player lost!
                if (timerInterval) clearInterval(timerInterval);
                document.getElementById('defeatText').textContent = `${currentBoss.emoji} ${currentBoss.name} vann!`;
                document.getElementById('defeatBossHp').textContent = bossHealth;
                document.getElementById('defeatScore').textContent = gameState.score;
                playSound('wrong');
                showScreen('defeatScreen');
            }
        }

        function updateBossHealth() {
            const percent = (bossHealth / currentBoss.health) * 100;
            document.getElementById('bossHealth').style.width = percent + '%';

            if (bossHealth <= 0) {
                // Stop the timer immediately
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }

                if (!gameState.bossesDefeated.includes(currentBoss.id)) {
                    gameState.bossesDefeated.push(currentBoss.id);
                }
                const timeElapsed = Math.floor((Date.now() - bossStartTime) / 1000);
                document.getElementById('victoryText').textContent = `Du besegrade ${currentBoss.name}!`;
                document.getElementById('victoryScore').textContent = gameState.score;
                document.getElementById('victoryTime').textContent = timeElapsed + 's';

                // Clear the boss to prevent further actions
                currentBoss = null;

                createConfetti();
                playSound('victory');
                saveGameState();
                showScreen('victoryScreen');
            }
        }

        // ==================== DAILY CHALLENGES ====================
        const dailyChallenges = [
            { type: 'streak', text: 'F√• en svit p√• 10!', check: () => gameState.streak >= 10 },
            { type: 'questions', text: 'Svara p√• 30 fr√•gor!', check: () => gameState.dailyQuestions >= 30 },
            { type: 'table', text: '√ñva 5:ans tabell 15 g√•nger!', table: 5, check: () => getDailyTableCount(5) >= 15 },
            { type: 'accuracy', text: 'F√• 90% r√§tt p√• 20 fr√•gor!', check: () => gameState.total >= 20 && (gameState.correct / gameState.total) >= 0.9 },
            { type: 'boss', text: 'Besegra en boss!', check: () => currentBoss && bossHealth <= 0 }
        ];

        let dailyTableCount = {};

        function getDailyTableCount(table) { return dailyTableCount[table] || 0; }

        function getTodaysChallenge() {
            const seed = new Date().toDateString().split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            return dailyChallenges[seed % dailyChallenges.length];
        }

        function updateDailyChallengeCard() {
            const challenge = getTodaysChallenge();
            document.getElementById('dailyChallengeText').textContent = challenge.text;
            if (gameState.dailyChallengeCompleted) {
                document.getElementById('dailyChallengeCard').style.opacity = '0.5';
                document.getElementById('dailyChallengeText').textContent += ' ‚úì Klar!';
            }
        }

        function startDailyChallenge() {
            const challenge = getTodaysChallenge();
            if (challenge.table) gameState.selectedTables = [challenge.table];
            startGame('challenge');
        }

        function checkDailyChallenge() {
            if (gameState.dailyChallengeCompleted) return;
            const challenge = getTodaysChallenge();
            if (challenge.check()) {
                gameState.dailyChallengeCompleted = true;
                gameState.totalScore += 100;
                createConfetti();
                playSound('victory');
                saveGameState();
            }
        }

        // ==================== SOUND SYSTEM ====================
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (!gameState.soundEnabled) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            switch(type) {
                case 'correct':
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                case 'wrong':
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
                case 'levelup':
                    [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.1 + 0.2);
                        osc.start(audioContext.currentTime + i * 0.1);
                        osc.stop(audioContext.currentTime + i * 0.1 + 0.2);
                    });
                    return;
                case 'victory':
                    [523.25, 659.25, 783.99, 1046.50, 1318.51, 1567.98].forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.08);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.08 + 0.3);
                        osc.start(audioContext.currentTime + i * 0.08);
                        osc.stop(audioContext.currentTime + i * 0.08 + 0.3);
                    });
                    return;
            }
        }

        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            document.getElementById('soundToggle').textContent = gameState.soundEnabled ? 'üîä Ljud p√•' : 'üîá Ljud av';
            saveGameState();
        }

        // ==================== ACHIEVEMENTS ====================
        const achievements = [
            { id: 'first_correct', name: 'F√∂rsta steget', icon: '‚≠ê', desc: 'F√∂rsta r√§tta svaret', condition: (s) => s.totalCorrect >= 1 },
            { id: 'ten_correct', name: 'Smart start', icon: 'üß†', desc: '10 r√§tt svar', condition: (s) => s.totalCorrect >= 10 },
            { id: 'fifty_correct', name: 'P√• rulle', icon: 'üíÖ', desc: '50 r√§tt svar', condition: (s) => s.totalCorrect >= 50 },
            { id: 'hundred_correct', name: 'Stj√§rna', icon: 'üëë', desc: '100 r√§tt svar', condition: (s) => s.totalCorrect >= 100 },
            { id: 'fivehundred_correct', name: 'Mattem√§stare', icon: 'üêê', desc: '500 r√§tt svar', condition: (s) => s.totalCorrect >= 500 },
            { id: 'streak_5', name: 'Bra flyt', icon: 'üî•', desc: '5 r√§tt i rad', condition: (s) => s.bestStreak >= 5 },
            { id: 'streak_10', name: 'Superfokus', icon: 'üçΩÔ∏è', desc: '10 r√§tt i rad', condition: (s) => s.bestStreak >= 10 },
            { id: 'streak_20', name: 'Koncentrerad', icon: 'üóø', desc: '20 r√§tt i rad', condition: (s) => s.bestStreak >= 20 },
            { id: 'streak_50', name: 'Ofelbar', icon: 'üíÄ', desc: '50 r√§tt i rad', condition: (s) => s.bestStreak >= 50 },
            { id: 'level_5', name: 'V√§xer', icon: 'üìà', desc: 'N√• niv√• 5', condition: (s) => s.level >= 5 },
            { id: 'level_10', name: 'Expert', icon: 'üè†', desc: 'N√• niv√• 10', condition: (s) => s.level >= 10 },
            { id: 'daily_goal', name: 'M√•lmedveten', icon: 'üí™', desc: 'Klara dagens m√•l', condition: (s) => s.dailyQuestions >= s.dailyGoal },
            { id: 'boss_slayer', name: 'Bossbesegrare', icon: '‚öîÔ∏è', desc: 'Besegra en boss', condition: (s) => s.bossesDefeated.length >= 1 },
            { id: 'all_bosses', name: 'Champion', icon: 'üéÆ', desc: 'Besegra alla bossar', condition: (s) => s.bossesDefeated.length >= bosses.length },
            { id: 'theme_collector', name: 'Samlare', icon: 'üé®', desc: 'L√•s upp 3 teman', condition: (s) => s.unlockedThemes.length >= 3 },
            { id: 'speed_demon', name: 'Blixtsnabb', icon: '‚ö°', desc: 'Svar under 2 sekunder', condition: (s) => s.fastAnswer },
            { id: 'rich', name: 'Po√§ngsamlare', icon: 'üìä', desc: '10000 po√§ng totalt', condition: (s) => s.totalScore >= 10000 }
        ];

        const levelTitles = ['Nyb√∂rjare', 'Lansen', 'R√§knare', 'Talkn√§ckare', 'Stj√§rna', 'Superhj√§rna', 'M√§stare', 'Expert', 'Champion', 'Legend', 'Geni', 'Mattewizard', 'Mattehj√§lte', 'Mattekung', 'Mattedrottning üëë'];

        const encouragements = [
            "Du fixar detta! üí™",
            "K√§mpa p√•! üî•",
            "Snart i m√•l! ‚ú®",
            "Du √§r grym! üåü",
            "Forts√§tt s√•! üöÄ",
            "Bra jobbat! üëè",
            "Du rockar! üé∏",
            "Stj√§rna! ‚≠ê"
        ];
        const correctMessages = [
            "R√§tt! üåü",
            "Snyggt! ‚ú®",
            "Perfekt! üéØ",
            "Toppen! üî•",
            "Grym! üí™",
            "Bra! üëè",
            "Yes! üöÄ",
            "Superbt! ‚≠ê",
            "Pricks√§kert! üéØ",
            "Snillrikt! üß†",
            "Fantastiskt! üåà",
            "M√§sterligt! üëë"
        ];
        const incorrectMessages = [
            "N√§stan!",
            "F√∂rs√∂k igen!",
            "Du klarar n√§sta!",
            "Snart d√§r!",
            "Ge inte upp!",
            "√ñvning ger f√§rdighet!"
        ];

        // ==================== GAME LOGIC ====================
        let currentQuestion = { num1: 0, num2: 0, answer: 0 };
        let questionStartTime = 0;

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            if (screenId === 'statsScreen') updateStatsScreen();
            if (screenId === 'startScreen') {
                updateDailyProgress();
                updateDailyChallengeCard();
                updateProfileDisplay();
                updateShopPreview();
            }
            if (screenId === 'leaderboardScreen') loadLeaderboard();
        }

        function startGame(mode) {
            gameState.mode = mode;
            gameState.score = 0;
            gameState.correct = 0;
            gameState.total = 0;
            gameState.streak = 0;

            // Reset round counters for practice mode
            currentRound = 1;
            questionsThisRound = 0;

            if (mode !== 'boss') {
                document.getElementById('bossArea').style.display = 'none';
                document.getElementById('timerBar').style.display = 'none';
                document.getElementById('smartIndicator').style.display = 'block';
                document.getElementById('roundProgress').style.display = 'block';
                updateRoundProgress();
            } else {
                document.getElementById('roundProgress').style.display = 'none';
            }

            showScreen('gameScreen');
            updateDisplay();

            // Show initial encouragement
            const encouragementEl = document.getElementById('encouragement');
            encouragementEl.textContent = encouragements[Math.floor(Math.random() * encouragements.length)];
            encouragementEl.classList.add('visible');

            generateQuestion();
            document.getElementById('answerInput').focus();

            if (audioContext.state === 'suspended') audioContext.resume();
        }

        function endGame() {
            if (timerInterval) clearInterval(timerInterval);
            currentBoss = null;
            showScreen('startScreen');
        }

        function updateRoundProgress() {
            document.getElementById('roundNumber').textContent = currentRound;
            document.getElementById('questionInRound').textContent = questionsThisRound;
            const percent = (questionsThisRound / QUESTIONS_PER_ROUND) * 100;
            document.getElementById('roundProgressBar').style.width = percent + '%';
        }

        function showRoundComplete() {
            const roundCorrect = gameState.correct;
            const accuracy = gameState.total > 0 ? Math.round((gameState.correct / gameState.total) * 100) : 0;

            document.getElementById('roundCompleteText').textContent = `Runda ${currentRound} avklarad! Bra jobbat! üî•`;
            document.getElementById('roundCorrect').textContent = roundCorrect;
            document.getElementById('roundAccuracy').textContent = accuracy + '%';
            document.getElementById('roundPoints').textContent = gameState.score;

            // Performance messages
            let message = '';
            if (accuracy >= 90) {
                message = 'Fantastiskt! Du √§r en stj√§rna! ‚≠ê';
            } else if (accuracy >= 70) {
                message = 'Bra jobbat! Forts√§tt s√•! üí™';
            } else if (accuracy >= 50) {
                message = 'Bra f√∂rs√∂k! N√§sta runda blir √§nnu b√§ttre! üöÄ';
            } else {
                message = 'Forts√§tt √∂va! Du klarar detta! üíØ';
            }
            document.getElementById('roundMessage').textContent = message;

            createConfetti();
            playSound('levelup');
            saveGameState();
            showScreen('roundCompleteScreen');
        }

        function startNextRound() {
            currentRound++;
            questionsThisRound = 0;
            // Keep score and stats, just reset round counter
            showScreen('gameScreen');
            updateRoundProgress();
            generateQuestion();
            document.getElementById('answerInput').focus();
        }

        function generateQuestion() {
            // Check if round is complete (only in practice mode)
            if (gameState.mode === 'practice' && questionsThisRound >= QUESTIONS_PER_ROUND) {
                showRoundComplete();
                return;
            }

            let selected;
            let questionText;
            let answer;
            let key;

            // Boss mode always uses multiplication
            if (gameState.mode === 'boss') {
                if (currentBoss && currentBoss.id === 'phoenix') {
                    selected = selectSmartQuestion();
                } else {
                    selected = {
                        num1: currentBoss.tables[Math.floor(Math.random() * currentBoss.tables.length)],
                        num2: Math.floor(Math.random() * 10) + 1
                    };
                }
                answer = selected.num1 * selected.num2;
                questionText = `${selected.num1} √ó ${selected.num2} = ?`;
                key = `${selected.num1}x${selected.num2}`;
            } else {
                // Practice mode - use selected math type
                switch (currentMathType) {
                    case 'addition': {
                        const range = getDifficultyRange();
                        const num1 = Math.floor(Math.random() * range.max) + range.min;
                        const num2 = Math.floor(Math.random() * range.max) + range.min;
                        answer = num1 + num2;
                        questionText = `${num1} + ${num2} = ?`;
                        key = `${num1}+${num2}`;
                        selected = { num1, num2 };
                        break;
                    }
                    case 'subtraction': {
                        const range = getDifficultyRange();
                        // Make sure num1 >= num2 so answer is positive
                        let num1 = Math.floor(Math.random() * range.max) + range.min;
                        let num2 = Math.floor(Math.random() * range.max) + range.min;
                        if (num2 > num1) [num1, num2] = [num2, num1];
                        answer = num1 - num2;
                        questionText = `${num1} ‚àí ${num2} = ?`;
                        key = `${num1}-${num2}`;
                        selected = { num1, num2 };
                        break;
                    }
                    case 'tiokompisar': {
                        const num1 = Math.floor(Math.random() * 10) + 1; // 1-10
                        answer = 10 - num1;
                        questionText = `${num1} + ? = 10`;
                        key = `10kompis_${num1}`;
                        selected = { num1, num2: answer };
                        break;
                    }
                    default: // multiplication
                        selected = selectSmartQuestion();
                        answer = selected.num1 * selected.num2;
                        questionText = `${selected.num1} √ó ${selected.num2} = ?`;
                        key = `${selected.num1}x${selected.num2}`;
                }
            }

            currentQuestion = {
                num1: selected.num1,
                num2: selected.num2,
                answer: answer,
                key: key
            };

            // Increment round progress for practice mode
            if (gameState.mode === 'practice') {
                questionsThisRound++;
                updateRoundProgress();
            }

            document.getElementById('question').textContent = questionText;
            document.getElementById('answerInput').value = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('tipBox').classList.remove('visible');

            questionStartTime = Date.now();

            if (gameState.mode === 'boss') startQuestionTimer();

            // Show encouragement with animation (30% chance per question)
            const encouragementEl = document.getElementById('encouragement');
            if (Math.random() < 0.3) {
                encouragementEl.classList.remove('visible', 'pop');
                encouragementEl.textContent = encouragements[Math.floor(Math.random() * encouragements.length)];
                // Trigger reflow for animation
                void encouragementEl.offsetWidth;
                encouragementEl.classList.add('visible', 'pop');
            }
        }

        function startQuestionTimer() {
            const timerFill = document.getElementById('timerFill');
            let timeLeft = 100;

            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                timeLeft -= 1.3;
                timerFill.style.width = timeLeft + '%';

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleWrongAnswer(true);
                }
            }, 100);
        }

        function checkAnswer() {
            const input = document.getElementById('answerInput');
            const userAnswer = parseInt(input.value);
            const feedback = document.getElementById('feedback');

            if (isNaN(userAnswer)) {
                feedback.textContent = "Skriv ett tal! üî¢";
                return;
            }

            const responseTime = Date.now() - questionStartTime;
            if (timerInterval) clearInterval(timerInterval);

            if (!factStats[currentQuestion.key]) {
                factStats[currentQuestion.key] = { correct: 0, wrong: 0, totalTime: 0, attempts: 0, lastPracticed: null, streak: 0 };
            }

            factStats[currentQuestion.key].attempts++;
            factStats[currentQuestion.key].totalTime += responseTime;
            factStats[currentQuestion.key].lastPracticed = Date.now();

            if (!dailyTableCount[currentQuestion.num1]) dailyTableCount[currentQuestion.num1] = 0;
            dailyTableCount[currentQuestion.num1]++;

            gameState.total++;
            gameState.dailyQuestions++;

            if (userAnswer === currentQuestion.answer) {
                handleCorrectAnswer(responseTime);
            } else {
                handleWrongAnswer(false);
            }

            updateDisplay();
            checkAchievements();
            checkDailyChallenge();
            saveGameState();
            updateLeaderboard();
        }

        function handleCorrectAnswer(responseTime) {
            const feedback = document.getElementById('feedback');

            gameState.correct++;
            gameState.totalCorrect++;
            gameState.streak++;
            factStats[currentQuestion.key].correct++;
            factStats[currentQuestion.key].streak++;

            if (responseTime < 2000) gameState.fastAnswer = true;

            let points = 10;
            if (gameState.streak > 1) points += gameState.streak * 2;
            if (gameState.mode === 'boss') points *= 2;
            if (responseTime < 3000) points += 5;

            gameState.score += points;
            gameState.totalScore += points;

            gameState.xp += points;
            while (gameState.xp >= gameState.xpToNext) levelUp();

            if (gameState.streak > gameState.bestStreak) gameState.bestStreak = gameState.streak;

            if (gameState.mode === 'boss') {
                bossHealth--;
                updateBossHealth();

                // If boss was defeated, don't generate another question
                if (bossHealth <= 0 || !currentBoss) {
                    return;
                }
            }

            feedback.textContent = correctMessages[Math.floor(Math.random() * correctMessages.length)];
            feedback.className = 'feedback correct';
            playSound('correct');

            if (gameState.streak % 5 === 0) createConfetti();

            setTimeout(generateQuestion, 700);
        }

        function handleWrongAnswer(timeout) {
            const feedback = document.getElementById('feedback');

            gameState.streak = 0;
            factStats[currentQuestion.key].wrong++;
            // Track negative streaks for facts repeatedly wrong
            if (factStats[currentQuestion.key].streak > 0) {
                factStats[currentQuestion.key].streak = -1;
            } else {
                factStats[currentQuestion.key].streak--;
            }

            if (timeout) {
                feedback.textContent = `Tiden tog slut! Svaret var ${currentQuestion.answer}`;
            } else {
                feedback.textContent = `${incorrectMessages[Math.floor(Math.random() * incorrectMessages.length)]} Svaret var ${currentQuestion.answer}`;
            }

            feedback.className = 'feedback incorrect';
            playSound('wrong');

            // Boss mode punishment - lose a life and boss heals
            if (currentBoss) {
                playerLives--;
                bossHealth = Math.min(bossHealth + 1, currentBoss.health); // Boss heals 1 HP
                updatePlayerLives();
                updateBossHealth();

                if (playerLives <= 0) {
                    return; // Game over handled by updatePlayerLives
                }
            }

            // Only show tips in practice mode for multiplication (tips are for times tables)
            if (gameState.mode === 'practice' && currentMathType === 'multiplication') {
                const tip = getTipForQuestion(currentQuestion.num1, currentQuestion.num2);
                if (tip) {
                    document.getElementById('tipContent').innerHTML = tip;
                    document.getElementById('tipBox').classList.add('visible');
                    // Don't auto-continue - wait for user to click button
                    return;
                }
            }

            setTimeout(generateQuestion, 2000);
        }

        function dismissTipAndContinue() {
            document.getElementById('tipBox').classList.remove('visible');
            generateQuestion();
            document.getElementById('answerInput').focus();
        }

        function levelUp() {
            gameState.level++;
            gameState.xp -= gameState.xpToNext;
            gameState.xpToNext = Math.floor(gameState.xpToNext * 1.15);
            createConfetti();
            playSound('levelup');
        }

        function updateDisplay() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('correct').textContent = gameState.correct;
            document.getElementById('total').textContent = gameState.total;
            document.getElementById('streak').textContent = gameState.streak;
            document.getElementById('streakFire').style.display = gameState.streak > 0 ? 'inline' : 'none';
            document.getElementById('levelText').textContent = `Niv√• ${gameState.level}`;
            document.getElementById('levelTitle').textContent = levelTitles[Math.min(gameState.level - 1, levelTitles.length - 1)];
            document.getElementById('xpBar').style.width = `${(gameState.xp / gameState.xpToNext) * 100}%`;
        }

        function updateDailyProgress() {
            const progress = Math.min(gameState.dailyQuestions, gameState.dailyGoal);
            document.getElementById('dailyProgress').textContent = `${progress} / ${gameState.dailyGoal} fr√•gor`;
            document.getElementById('dailyProgressBar').style.width = `${(progress / gameState.dailyGoal) * 100}%`;
        }

        function updateStatsScreen() {
            document.getElementById('totalCorrectStat').textContent = gameState.totalCorrect;
            document.getElementById('bestStreakStat').textContent = gameState.bestStreak;
            document.getElementById('levelStat').textContent = gameState.level;
            renderHeatmap();
            renderBadges('statsBadges');
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmap');
            container.innerHTML = '';

            const corner = document.createElement('div');
            corner.className = 'heatmap-cell';
            corner.textContent = '√ó';
            container.appendChild(corner);

            for (let i = 1; i <= 10; i++) {
                const header = document.createElement('div');
                header.className = 'heatmap-cell heatmap-header';
                header.textContent = i;
                container.appendChild(header);
            }

            for (let i = 1; i <= 10; i++) {
                const rowHeader = document.createElement('div');
                rowHeader.className = 'heatmap-cell heatmap-header';
                rowHeader.textContent = i;
                container.appendChild(rowHeader);

                for (let j = 1; j <= 10; j++) {
                    const cell = document.createElement('div');
                    const key = `${i}x${j}`;
                    const stat = factStats[key];

                    let className = 'heatmap-cell heatmap-new';
                    if (stat && stat.attempts > 0) {
                        const accuracy = stat.correct / stat.attempts;
                        if (accuracy >= 0.9 && stat.attempts >= 5) className = 'heatmap-cell heatmap-mastered';
                        else if (accuracy >= 0.7) className = 'heatmap-cell heatmap-good';
                        else if (accuracy >= 0.5) className = 'heatmap-cell heatmap-learning';
                        else className = 'heatmap-cell heatmap-weak';
                    }

                    cell.className = className;
                    cell.textContent = i * j;
                    cell.title = stat ? `${i}√ó${j}: ${Math.round((stat.correct/stat.attempts)*100)}% r√§tt (${stat.attempts} f√∂rs√∂k)` : `${i}√ó${j}: Ej √∂vad`;
                    container.appendChild(cell);
                }
            }
        }

        function checkAchievements() {
            achievements.forEach(achievement => {
                if (!gameState.achievements[achievement.id] && achievement.condition(gameState)) {
                    gameState.achievements[achievement.id] = true;
                    createConfetti();
                }
            });
        }

        function renderBadges(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            achievements.forEach(achievement => {
                const badge = document.createElement('div');
                badge.className = `badge ${gameState.achievements[achievement.id] ? 'unlocked' : 'locked'}`;
                badge.innerHTML = `${achievement.icon}<span class="badge-tooltip">${achievement.name}: ${achievement.desc}</span>`;
                container.appendChild(badge);
            });
        }

        function setupTableSelect() {
            const container = document.getElementById('tableSelect');
            container.innerHTML = '';

            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement('button');
                btn.className = 'table-btn';
                btn.textContent = i;
                if (gameState.selectedTables.includes(i)) btn.classList.add('selected');

                let mastered = true;
                for (let j = 1; j <= 10; j++) {
                    const stat = factStats[`${i}x${j}`];
                    if (!stat || stat.attempts < 5 || (stat.correct / stat.attempts) < 0.9) {
                        mastered = false;
                        break;
                    }
                }
                if (mastered) btn.classList.add('mastered');

                btn.onclick = () => {
                    const idx = gameState.selectedTables.indexOf(i);
                    if (idx > -1 && gameState.selectedTables.length > 1) {
                        gameState.selectedTables.splice(idx, 1);
                        btn.classList.remove('selected');
                    } else if (idx === -1) {
                        gameState.selectedTables.push(i);
                        btn.classList.add('selected');
                    }
                    saveGameState();
                };
                container.appendChild(btn);
            }
        }

        function createConfetti() {
            const celebration = document.getElementById('celebration');
            const colors = ['#667eea', '#764ba2', '#f093fb', '#ffecd2', '#fcb69f', '#00b894', '#fddb92'];

            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                celebration.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        // ==================== PERSISTENCE ====================
        function saveGameState() {
            if (!currentProfile) return;

            // Save to localStorage (immediate)
            localStorage.setItem(`mathStars_${currentProfile.id}_state`, JSON.stringify(gameState));
            localStorage.setItem(`mathStars_${currentProfile.id}_facts`, JSON.stringify(factStats));

            // Also save to Firebase (async, for cross-device sync)
            database.ref('gameStates/' + currentProfile.id).set(gameState)
                .catch(err => console.error('Firebase save error:', err));
            database.ref('factStats/' + currentProfile.id).set(factStats)
                .catch(err => console.error('Firebase factStats save error:', err));
        }

        async function loadGameState() {
            if (!currentProfile) return;

            try {
                // Try to load from Firebase first (most up-to-date)
                const stateSnapshot = await database.ref('gameStates/' + currentProfile.id).once('value');
                const factsSnapshot = await database.ref('factStats/' + currentProfile.id).once('value');

                if (stateSnapshot.exists()) {
                    gameState = { ...gameState, ...stateSnapshot.val() };
                    // Also update localStorage cache
                    localStorage.setItem(`mathStars_${currentProfile.id}_state`, JSON.stringify(gameState));
                } else {
                    // Fallback to localStorage
                    const saved = localStorage.getItem(`mathStars_${currentProfile.id}_state`);
                    if (saved) gameState = { ...gameState, ...JSON.parse(saved) };
                }

                if (factsSnapshot.exists()) {
                    factStats = factsSnapshot.val();
                    localStorage.setItem(`mathStars_${currentProfile.id}_facts`, JSON.stringify(factStats));
                } else {
                    const savedFacts = localStorage.getItem(`mathStars_${currentProfile.id}_facts`);
                    if (savedFacts) factStats = JSON.parse(savedFacts);
                }
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                // Fallback to localStorage
                const saved = localStorage.getItem(`mathStars_${currentProfile.id}_state`);
                if (saved) gameState = { ...gameState, ...JSON.parse(saved) };
                const savedFacts = localStorage.getItem(`mathStars_${currentProfile.id}_facts`);
                if (savedFacts) factStats = JSON.parse(savedFacts);
            }
        }

        function checkDailyReset() {
            const today = new Date().toDateString();
            if (gameState.lastPlayDate !== today) {
                gameState.dailyQuestions = 0;
                gameState.dailyChallengeCompleted = false;
                gameState.lastPlayDate = today;
                dailyTableCount = {};
                saveGameState();
            }
        }

        // ==================== INITIALIZATION ====================
        function init() {
            initFirebase();
            renderAvatarGrid();

            document.getElementById('nameInput').addEventListener('input', checkCanCreate);

            if (loadCurrentProfile()) {
                initFactStats();
                checkDailyReset();
                applyTheme(gameState.currentTheme);
                setupTableSelect();
                renderThemeSelector();
                updateDailyProgress();
                updateDailyChallengeCard();
                document.getElementById('soundToggle').textContent = gameState.soundEnabled ? 'üîä Ljud p√•' : 'üîá Ljud av';
                showScreen('startScreen');
            } else {
                loadExistingProfiles();
                showScreen('loginScreen');
            }

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && document.getElementById('gameScreen').classList.contains('active')) {
                    checkAnswer();
                }
            });
        }

        init();
    </script>
</body>
</html>
