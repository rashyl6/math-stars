<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Math Stars - Multiplikations√§ventyr!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --bg-start: #667eea;
            --bg-mid: #764ba2;
            --bg-end: #f093fb;
            --card-bg: white;
            --text: #333;
            --text-light: #666;
        }

        /* Theme: Space */
        .theme-space {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #e94560;
            --bg-start: #0f0f23;
            --bg-mid: #1a1a2e;
            --bg-end: #16213e;
            --card-bg: rgba(255,255,255,0.95);
        }

        /* Theme: Ocean */
        .theme-ocean {
            --primary: #0077b6;
            --secondary: #00b4d8;
            --accent: #90e0ef;
            --bg-start: #03045e;
            --bg-mid: #0077b6;
            --bg-end: #00b4d8;
            --card-bg: rgba(255,255,255,0.95);
        }

        /* Theme: Forest */
        .theme-forest {
            --primary: #2d6a4f;
            --secondary: #40916c;
            --accent: #95d5b2;
            --bg-start: #1b4332;
            --bg-mid: #2d6a4f;
            --bg-end: #52b788;
            --card-bg: rgba(255,255,255,0.95);
        }

        /* Theme: Unicorn */
        .theme-unicorn {
            --primary: #ff6b9d;
            --secondary: #c44569;
            --accent: #ffc8dd;
            --bg-start: #ff6b9d;
            --bg-mid: #c44569;
            --bg-end: #ffc8dd;
            --card-bg: rgba(255,255,255,0.98);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-mid) 50%, var(--bg-end) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            transition: background 0.5s;
        }

        .container {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-height: 95vh;
            overflow-y: auto;
        }

        .title {
            font-size: 2em;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .subtitle {
            color: var(--text-light);
            margin-bottom: 15px;
            font-size: 1em;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--secondary);
        }

        .stat-label {
            font-size: 0.75em;
            color: var(--text-light);
        }

        .streak-display {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .streak-fire {
            font-size: 1.3em;
            animation: bounce 0.5s ease infinite alternate;
        }

        @keyframes bounce {
            from { transform: scale(1); }
            to { transform: scale(1.2); }
        }

        .question-area {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 15px;
        }

        .question {
            font-size: 2.2em;
            color: var(--text);
            margin-bottom: 15px;
        }

        .timer-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #00b894, #fdcb6e, #e17055);
            border-radius: 4px;
            transition: width 0.1s linear;
        }

        .answer-input {
            font-size: 1.8em;
            width: 120px;
            padding: 10px;
            border: 3px solid var(--secondary);
            border-radius: 15px;
            text-align: center;
            outline: none;
            transition: all 0.3s;
        }

        .answer-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(240, 147, 251, 0.5);
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 12px 35px;
            font-size: 1.2em;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .feedback {
            font-size: 1.3em;
            margin: 12px 0;
            min-height: 35px;
            font-weight: bold;
        }

        .feedback.correct {
            color: #00b894;
            animation: pop 0.3s ease;
        }

        .feedback.incorrect {
            color: #e17055;
            animation: shake 0.3s ease;
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .tip-box {
            background: linear-gradient(135deg, #fddb92 0%, #d1fdff 100%);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
            display: none;
        }

        .tip-box.visible {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tip-title {
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        .tip-content {
            color: var(--text);
            font-size: 0.95em;
            line-height: 1.4;
        }

        .achievements-section {
            margin-top: 15px;
        }

        .achievements-title {
            font-size: 1.2em;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .badges-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }

        .badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
        }

        .badge.locked {
            background: #ddd;
            filter: grayscale(100%);
            opacity: 0.5;
        }

        .badge.unlocked {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            box-shadow: 0 5px 15px rgba(252, 182, 159, 0.5);
        }

        .badge-tooltip {
            position: absolute;
            bottom: -35px;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.45em;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 100;
        }

        .badge:hover .badge-tooltip {
            opacity: 1;
        }

        .level-display {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 12px;
            font-size: 1em;
        }

        .progress-bar-container {
            background: #eee;
            border-radius: 10px;
            height: 15px;
            margin: 8px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: fall 3s ease-out forwards;
        }

        @keyframes fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .start-btn, .mode-btn-large {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.3em;
            border-radius: 30px;
            cursor: pointer;
            margin: 8px;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0, 184, 148, 0.4);
        }

        .start-btn:hover, .mode-btn-large:hover {
            transform: translateY(-3px) scale(1.02);
        }

        .boss-btn {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
        }

        .mascot {
            font-size: 3.5em;
            margin-bottom: 5px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .daily-goal {
            background: linear-gradient(135deg, #fddb92 0%, #d1fdff 100%);
            border-radius: 15px;
            padding: 12px;
            margin: 12px 0;
        }

        .heatmap {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            gap: 3px;
            margin: 15px 0;
            font-size: 0.7em;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .heatmap-cell:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .heatmap-header {
            background: var(--secondary);
            color: white;
        }

        .heatmap-mastered { background: #00b894; color: white; }
        .heatmap-good { background: #55efc4; }
        .heatmap-learning { background: #fdcb6e; }
        .heatmap-weak { background: #fab1a0; }
        .heatmap-new { background: #dfe6e9; }

        .theme-selector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .theme-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .theme-btn.selected {
            border-color: #333;
            transform: scale(1.1);
        }

        .theme-btn.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .theme-btn.locked::after {
            content: 'üîí';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
        }

        .theme-default { background: linear-gradient(135deg, #667eea, #f093fb); }
        .theme-space { background: linear-gradient(135deg, #0f0f23, #1a1a2e); }
        .theme-ocean { background: linear-gradient(135deg, #03045e, #00b4d8); }
        .theme-forest { background: linear-gradient(135deg, #1b4332, #52b788); }
        .theme-unicorn { background: linear-gradient(135deg, #ff6b9d, #ffc8dd); }

        .boss-container {
            text-align: center;
            padding: 20px;
        }

        .boss-emoji {
            font-size: 4em;
            animation: bossFloat 1s ease-in-out infinite;
        }

        @keyframes bossFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-15px) scale(1.1); }
        }

        .boss-health-bar {
            background: #eee;
            border-radius: 10px;
            height: 25px;
            margin: 15px 0;
            overflow: hidden;
            border: 2px solid #333;
        }

        .boss-health-fill {
            height: 100%;
            background: linear-gradient(90deg, #e17055, #d63031);
            transition: width 0.3s;
        }

        .boss-name {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--secondary);
            margin: 10px 0;
        }

        .daily-challenge-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
        }

        .nav-btn {
            padding: 10px 20px;
            margin: 5px;
            border: 2px solid var(--secondary);
            background: white;
            color: var(--secondary);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .nav-btn:hover {
            background: var(--secondary);
            color: white;
        }

        .table-select {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
            margin: 10px 0;
        }

        .table-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--secondary);
            background: white;
            color: var(--secondary);
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .table-btn.selected {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .table-btn.mastered {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            border-color: #00b894;
        }

        .smart-indicator {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 10px;
            padding: 8px 15px;
            margin: 10px 0;
            font-size: 0.85em;
            color: var(--text-light);
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
                border-radius: 20px;
            }

            .title { font-size: 1.6em; }
            .question { font-size: 1.8em; }
            .answer-input { font-size: 1.5em; width: 100px; }
            .badge { width: 40px; height: 40px; font-size: 1.2em; }
            .heatmap { font-size: 0.6em; }
            .start-btn, .mode-btn-large { padding: 12px 30px; font-size: 1.1em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Start Screen -->
        <div class="screen active" id="startScreen">
            <div class="mascot">üåü</div>
            <h1 class="title">Math Stars</h1>
            <p class="subtitle">Multiplikations√§ventyr!</p>

            <div class="daily-goal">
                <div style="color: #666; font-size: 0.9em;">Dagens framsteg</div>
                <div style="font-size: 1.2em; font-weight: bold; color: #764ba2;" id="dailyProgress">0 / 20 fr√•gor</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="dailyProgressBar" style="width: 0%"></div>
                </div>
            </div>

            <div class="daily-challenge-card" id="dailyChallengeCard">
                <div style="font-weight: bold; color: #764ba2;">üéØ Dagens utmaning</div>
                <div id="dailyChallengeText" style="margin: 5px 0;"></div>
                <button class="nav-btn" onclick="startDailyChallenge()">Starta!</button>
            </div>

            <button class="start-btn" onclick="startGame('practice')">‚ñ∂Ô∏è √ñva</button>
            <button class="mode-btn-large boss-btn" onclick="showBossSelect()">üêâ Bossutmaning</button>

            <button class="nav-btn" onclick="showScreen('statsScreen')">üìä Statistik</button>
            <button class="nav-btn" onclick="showScreen('settingsScreen')">‚öôÔ∏è Inst√§llningar</button>
        </div>

        <!-- Settings Screen -->
        <div class="screen" id="settingsScreen">
            <h2 class="title">Inst√§llningar</h2>

            <h3 style="margin: 15px 0 10px; color: #666;">V√§lj tabeller att √∂va</h3>
            <div class="table-select" id="tableSelect"></div>

            <h3 style="margin: 15px 0 10px; color: #666;">V√§lj tema</h3>
            <div class="theme-selector" id="themeSelector"></div>
            <p style="font-size: 0.8em; color: #888;">L√•s upp fler teman genom att samla po√§ng!</p>

            <h3 style="margin: 15px 0 10px; color: #666;">Ljud</h3>
            <button class="nav-btn" id="soundToggle" onclick="toggleSound()">üîä Ljud p√•</button>

            <br><br>
            <button class="nav-btn" onclick="showScreen('startScreen')">üè† Tillbaka</button>
        </div>

        <!-- Stats Screen -->
        <div class="screen" id="statsScreen">
            <h2 class="title">üìä Statistik</h2>

            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="totalCorrectStat">0</div>
                    <div class="stat-label">Totalt r√§tt</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="bestStreakStat">0</div>
                    <div class="stat-label">B√§sta svit</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="levelStat">1</div>
                    <div class="stat-label">Niv√•</div>
                </div>
            </div>

            <h3 style="margin: 15px 0 10px; color: var(--secondary);">Multiplikationskarta</h3>
            <p style="font-size: 0.8em; color: #888; margin-bottom: 10px;">Gr√∂n = kan bra, Gul = l√§r sig, R√∂d = beh√∂ver √∂va</p>
            <div class="heatmap" id="heatmap"></div>

            <div class="achievements-section">
                <div class="achievements-title">üèÜ M√§rken</div>
                <div class="badges-container" id="statsBadges"></div>
            </div>

            <button class="nav-btn" onclick="showScreen('startScreen')">üè† Tillbaka</button>
        </div>

        <!-- Boss Select Screen -->
        <div class="screen" id="bossSelectScreen">
            <h2 class="title">üêâ V√§lj Boss</h2>
            <p style="color: #666; margin-bottom: 15px;">Besegra bossen genom att svara r√§tt!</p>

            <div id="bossOptions"></div>

            <button class="nav-btn" onclick="showScreen('startScreen')">üè† Tillbaka</button>
        </div>

        <!-- Game Screen -->
        <div class="screen" id="gameScreen">
            <div class="level-display">
                <span id="levelText">Niv√• 1</span> - <span id="levelTitle">Nyb√∂rjare</span>
            </div>

            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="score">0</div>
                    <div class="stat-label">Po√§ng</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="correct">0</div>
                    <div class="stat-label">R√§tt</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total">0</div>
                    <div class="stat-label">Totalt</div>
                </div>
            </div>

            <div class="streak-display">
                <span class="streak-fire" id="streakFire">üî•</span>
                <span>Svit: <strong id="streak">0</strong></span>
            </div>

            <div class="smart-indicator" id="smartIndicator">
                üß† Smart √∂vning aktiv
            </div>

            <div class="question-area">
                <div id="bossArea" style="display: none;">
                    <div class="boss-emoji" id="bossEmoji">üêâ</div>
                    <div class="boss-name" id="bossName">Drake</div>
                    <div class="boss-health-bar">
                        <div class="boss-health-fill" id="bossHealth" style="width: 100%"></div>
                    </div>
                </div>

                <div class="timer-bar" id="timerBar" style="display: none;">
                    <div class="timer-fill" id="timerFill" style="width: 100%"></div>
                </div>

                <div class="question" id="question">5 √ó 7 = ?</div>
                <input type="number" class="answer-input" id="answerInput" inputmode="numeric" pattern="[0-9]*">
                <button class="submit-btn" onclick="checkAnswer()">Kolla! ‚úì</button>
                <div class="feedback" id="feedback"></div>
            </div>

            <div class="tip-box" id="tipBox">
                <div class="tip-title">üí° Tips!</div>
                <div class="tip-content" id="tipContent"></div>
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" id="xpBar" style="width: 0%"></div>
            </div>
            <p style="font-style: italic; color: #888; margin-top: 5px; font-size: 0.9em;" id="encouragement">Du klarar detta! üí™</p>

            <button class="nav-btn" onclick="endGame()">üè† Hem</button>
        </div>

        <!-- Boss Victory Screen -->
        <div class="screen" id="victoryScreen">
            <div class="mascot">üèÜ</div>
            <h1 class="title">SEGER!</h1>
            <p class="subtitle" id="victoryText">Du besegrade bossen!</p>

            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="victoryScore">0</div>
                    <div class="stat-label">Po√§ng</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="victoryTime">0s</div>
                    <div class="stat-label">Tid</div>
                </div>
            </div>

            <button class="start-btn" onclick="showScreen('startScreen')">üè† Hem</button>
        </div>
    </div>

    <div class="celebration" id="celebration"></div>

    <script>
        // ==================== GAME STATE ====================
        let gameState = {
            score: 0,
            correct: 0,
            total: 0,
            streak: 0,
            bestStreak: 0,
            level: 1,
            xp: 0,
            xpToNext: 100,
            totalScore: 0,
            selectedTables: [2, 3, 4, 5],
            mode: 'practice',
            dailyQuestions: 0,
            dailyGoal: 20,
            lastPlayDate: null,
            totalCorrect: 0,
            achievements: {},
            masteredTables: [],
            currentTheme: 'default',
            unlockedThemes: ['default'],
            soundEnabled: true,
            bossesDefeated: [],
            dailyChallengeCompleted: false,
            dailyChallengeType: null
        };

        // Detailed stats for each multiplication fact
        let factStats = {};

        // Initialize fact stats for all 1-10 √ó 1-10
        function initFactStats() {
            for (let i = 1; i <= 10; i++) {
                for (let j = 1; j <= 10; j++) {
                    const key = `${i}x${j}`;
                    if (!factStats[key]) {
                        factStats[key] = {
                            correct: 0,
                            wrong: 0,
                            totalTime: 0,
                            attempts: 0,
                            lastPracticed: null,
                            streak: 0
                        };
                    }
                }
            }
        }

        // ==================== SMART ALGORITHM ====================
        function getFactScore(key) {
            const stat = factStats[key];
            if (!stat || stat.attempts === 0) return 0.5; // Unknown facts get medium priority

            const accuracy = stat.correct / stat.attempts;
            const avgTime = stat.totalTime / stat.attempts;

            // Time factor: slower = needs more practice (normalize around 3 seconds)
            const timeFactor = Math.min(avgTime / 3000, 2);

            // Recency factor: older = needs more practice
            const daysSincePractice = stat.lastPracticed
                ? (Date.now() - stat.lastPracticed) / (1000 * 60 * 60 * 24)
                : 7;
            const recencyFactor = Math.min(daysSincePractice / 7, 1);

            // Lower score = needs more practice
            // We want: low accuracy, high time, old practice = low score = high priority
            return accuracy * 0.5 - timeFactor * 0.25 - recencyFactor * 0.25;
        }

        function selectSmartQuestion() {
            const candidates = [];

            for (const table of gameState.selectedTables) {
                for (let j = 1; j <= 10; j++) {
                    const key = `${table}x${j}`;
                    candidates.push({
                        num1: table,
                        num2: j,
                        key: key,
                        score: getFactScore(key)
                    });
                }
            }

            // Sort by score (lowest = needs most practice)
            candidates.sort((a, b) => a.score - b.score);

            // Pick from bottom 30% with some randomness for variety
            const poolSize = Math.max(3, Math.floor(candidates.length * 0.3));
            const pool = candidates.slice(0, poolSize);

            // Add a 20% chance to pick a random fact for variety
            if (Math.random() < 0.2) {
                const randomIdx = Math.floor(Math.random() * candidates.length);
                return candidates[randomIdx];
            }

            return pool[Math.floor(Math.random() * pool.length)];
        }

        // ==================== TIPS SYSTEM ====================
        const multiplicationTips = {
            '1': {
                general: "Allt g√•nger 1 √§r sig sj√§lvt! üéØ",
                examples: ["7 √ó 1 = 7", "1 √ó 9 = 9"]
            },
            '2': {
                general: "Dubbla talet! L√§gg ihop talet med sig sj√§lvt. ‚úåÔ∏è",
                examples: ["2 √ó 6 = 6 + 6 = 12", "2 √ó 8 = 8 + 8 = 16"]
            },
            '3': {
                general: "Dubbla och l√§gg till en g√•ng till! üî¢",
                examples: ["3 √ó 4 = (2 √ó 4) + 4 = 8 + 4 = 12", "3 √ó 7 = (2 √ó 7) + 7 = 14 + 7 = 21"]
            },
            '4': {
                general: "Dubbla tv√• g√•nger! F√∂rst √ó 2, sen √ó 2 igen. üé≤",
                examples: ["4 √ó 6 = 2 √ó 6 √ó 2 = 12 √ó 2 = 24", "4 √ó 7 = 2 √ó 7 √ó 2 = 14 √ó 2 = 28"]
            },
            '5': {
                general: "H√§lften av 10-g√•ngern! Eller: slutar alltid p√• 0 eller 5. ‚úã",
                examples: ["5 √ó 6 = (10 √ó 6) √∑ 2 = 60 √∑ 2 = 30", "5 √ó 7 = 35 (udda tal ‚Üí slutar p√• 5)"]
            },
            '6': {
                general: "3-g√•ngern dubblad! Eller 5-g√•ngern + en g√•ng till. üéØ",
                examples: ["6 √ó 4 = (3 √ó 4) √ó 2 = 12 √ó 2 = 24", "6 √ó 7 = (5 √ó 7) + 7 = 35 + 7 = 42"]
            },
            '7': {
                general: "Knepig! Prova 5-g√•ngern + 2-g√•ngern. üåü",
                examples: ["7 √ó 6 = (5 √ó 6) + (2 √ó 6) = 30 + 12 = 42", "7 √ó 8 = (5 √ó 8) + (2 √ó 8) = 40 + 16 = 56"]
            },
            '8': {
                general: "Dubbla tre g√•nger! 2 √ó 2 √ó 2 = 8. üöÄ",
                examples: ["8 √ó 6 = 2√ó2√ó2√ó6 = 2√ó2√ó12 = 2√ó24 = 48", "8 √ó 7 = (4 √ó 7) √ó 2 = 28 √ó 2 = 56"]
            },
            '9': {
                general: "Fingertricket! üñêÔ∏è Eller: (10 √ó talet) - talet",
                examples: ["9 √ó 7 = (10 √ó 7) - 7 = 70 - 7 = 63", "9 √ó 6: B√∂j finger 6, se 5 och 4 = 54"],
                special: "Fingertrick f√∂r 9:ans tabell: H√•ll upp 10 fingrar. F√∂r 9√óN, b√∂j ner finger nummer N. Fingrarna till v√§nster = tiotal, till h√∂ger = ental!"
            },
            '10': {
                general: "L√§gg till en nolla! Superenkelt! üîü",
                examples: ["10 √ó 7 = 70", "10 √ó 4 = 40"]
            }
        };

        function getTipForQuestion(num1, num2) {
            // Get tip for the harder number (usually the larger one)
            const tipNum = Math.max(num1, num2).toString();
            const tip = multiplicationTips[tipNum];

            if (!tip) return null;

            let content = `<strong>${tip.general}</strong><br><br>`;
            content += `Exempel: ${tip.examples.join('<br>')}`;

            if (tip.special) {
                content += `<br><br>üåü ${tip.special}`;
            }

            // Add specific tip for this exact problem
            const answer = num1 * num2;
            content += `<br><br>S√•: <strong>${num1} √ó ${num2} = ${answer}</strong>`;

            return content;
        }

        // ==================== THEMES ====================
        const themes = {
            default: { name: 'Standard', cost: 0, emoji: 'üåü' },
            space: { name: 'Rymd', cost: 500, emoji: 'üöÄ' },
            ocean: { name: 'Hav', cost: 500, emoji: 'üåä' },
            forest: { name: 'Skog', cost: 500, emoji: 'üå≤' },
            unicorn: { name: 'Enh√∂rning', cost: 1000, emoji: 'ü¶Ñ' }
        };

        function applyTheme(themeName) {
            document.body.className = themeName === 'default' ? '' : `theme-${themeName}`;
            gameState.currentTheme = themeName;
            saveGameState();
        }

        function renderThemeSelector() {
            const container = document.getElementById('themeSelector');
            container.innerHTML = '';

            for (const [key, theme] of Object.entries(themes)) {
                const btn = document.createElement('button');
                btn.className = `theme-btn theme-${key}`;

                const isUnlocked = gameState.unlockedThemes.includes(key);
                const isSelected = gameState.currentTheme === key;

                if (!isUnlocked) btn.classList.add('locked');
                if (isSelected) btn.classList.add('selected');

                btn.title = isUnlocked ? theme.name : `${theme.name} (${theme.cost} po√§ng)`;
                btn.onclick = () => {
                    if (isUnlocked) {
                        applyTheme(key);
                        renderThemeSelector();
                    } else if (gameState.totalScore >= theme.cost) {
                        gameState.unlockedThemes.push(key);
                        gameState.totalScore -= theme.cost;
                        applyTheme(key);
                        playSound('levelup');
                        createConfetti();
                        renderThemeSelector();
                        saveGameState();
                    }
                };

                container.appendChild(btn);
            }
        }

        // ==================== BOSSES ====================
        const bosses = [
            { id: 'dragon', name: 'Drake', emoji: 'üêâ', health: 10, tables: [2, 3], unlocked: true },
            { id: 'wizard', name: 'Trollkarl', emoji: 'üßô', health: 12, tables: [4, 5], unlocked: true },
            { id: 'robot', name: 'Robot', emoji: 'ü§ñ', health: 15, tables: [6, 7], requirement: 'level5' },
            { id: 'alien', name: 'Utomjording', emoji: 'üëΩ', health: 18, tables: [8, 9], requirement: 'level8' },
            { id: 'phoenix', name: 'Fenix', emoji: 'üî•', health: 20, tables: [1,2,3,4,5,6,7,8,9,10], requirement: 'level10' }
        ];

        let currentBoss = null;
        let bossHealth = 0;
        let bossStartTime = 0;
        let bossTimerInterval = null;

        function isBossUnlocked(boss) {
            if (boss.unlocked) return true;
            if (boss.requirement === 'level5') return gameState.level >= 5;
            if (boss.requirement === 'level8') return gameState.level >= 8;
            if (boss.requirement === 'level10') return gameState.level >= 10;
            return false;
        }

        function showBossSelect() {
            const container = document.getElementById('bossOptions');
            container.innerHTML = '';

            bosses.forEach(boss => {
                const unlocked = isBossUnlocked(boss);
                const defeated = gameState.bossesDefeated.includes(boss.id);

                const card = document.createElement('div');
                card.style.cssText = `
                    background: ${unlocked ? 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' : '#ddd'};
                    border-radius: 15px;
                    padding: 15px;
                    margin: 10px 0;
                    opacity: ${unlocked ? 1 : 0.5};
                    cursor: ${unlocked ? 'pointer' : 'not-allowed'};
                `;

                card.innerHTML = `
                    <div style="font-size: 2em;">${boss.emoji}</div>
                    <div style="font-weight: bold; color: #764ba2;">${boss.name}</div>
                    <div style="font-size: 0.8em; color: #666;">
                        ${unlocked ? `‚ù§Ô∏è ${boss.health} HP | Tabeller: ${boss.tables.join(', ')}` : 'üîí L√•s upp p√• h√∂gre niv√•'}
                    </div>
                    ${defeated ? '<div style="color: #00b894; font-size: 0.9em;">‚úì Besegrad!</div>' : ''}
                `;

                if (unlocked) {
                    card.onclick = () => startBossBattle(boss);
                }

                container.appendChild(card);
            });

            showScreen('bossSelectScreen');
        }

        function startBossBattle(boss) {
            currentBoss = boss;
            bossHealth = boss.health;
            bossStartTime = Date.now();
            gameState.selectedTables = boss.tables;
            gameState.mode = 'boss';

            document.getElementById('bossArea').style.display = 'block';
            document.getElementById('bossEmoji').textContent = boss.emoji;
            document.getElementById('bossName').textContent = boss.name;
            document.getElementById('bossHealth').style.width = '100%';
            document.getElementById('timerBar').style.display = 'block';
            document.getElementById('smartIndicator').style.display = 'none';

            startGame('boss');
        }

        function updateBossHealth() {
            const percent = (bossHealth / currentBoss.health) * 100;
            document.getElementById('bossHealth').style.width = percent + '%';

            if (bossHealth <= 0) {
                // Victory!
                if (!gameState.bossesDefeated.includes(currentBoss.id)) {
                    gameState.bossesDefeated.push(currentBoss.id);
                }

                const timeElapsed = Math.floor((Date.now() - bossStartTime) / 1000);
                document.getElementById('victoryText').textContent = `Du besegrade ${currentBoss.name}!`;
                document.getElementById('victoryScore').textContent = gameState.score;
                document.getElementById('victoryTime').textContent = timeElapsed + 's';

                createConfetti();
                playSound('victory');
                saveGameState();

                showScreen('victoryScreen');
            }
        }

        // ==================== DAILY CHALLENGES ====================
        const dailyChallenges = [
            { type: 'streak', target: 10, text: 'F√• en svit p√• 10!', check: () => gameState.streak >= 10 },
            { type: 'questions', target: 30, text: 'Svara p√• 30 fr√•gor!', check: () => gameState.dailyQuestions >= 30 },
            { type: 'table', target: 5, text: '√ñva 5:ans tabell 15 g√•nger!', table: 5, check: () => getDailyTableCount(5) >= 15 },
            { type: 'accuracy', target: 90, text: 'F√• 90% r√§tt p√• 20 fr√•gor!', check: () => gameState.total >= 20 && (gameState.correct / gameState.total) >= 0.9 },
            { type: 'boss', text: 'Besegra en boss!', check: () => currentBoss && bossHealth <= 0 }
        ];

        let dailyTableCount = {};

        function getDailyTableCount(table) {
            return dailyTableCount[table] || 0;
        }

        function getTodaysChallenge() {
            const today = new Date().toDateString();
            const seed = today.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            return dailyChallenges[seed % dailyChallenges.length];
        }

        function updateDailyChallengeCard() {
            const challenge = getTodaysChallenge();
            document.getElementById('dailyChallengeText').textContent = challenge.text;

            if (gameState.dailyChallengeCompleted) {
                document.getElementById('dailyChallengeCard').style.opacity = '0.5';
                document.getElementById('dailyChallengeText').textContent += ' ‚úì Klar!';
            }
        }

        function startDailyChallenge() {
            const challenge = getTodaysChallenge();
            if (challenge.table) {
                gameState.selectedTables = [challenge.table];
            }
            startGame('challenge');
        }

        function checkDailyChallenge() {
            if (gameState.dailyChallengeCompleted) return;

            const challenge = getTodaysChallenge();
            if (challenge.check()) {
                gameState.dailyChallengeCompleted = true;
                gameState.totalScore += 100;
                createConfetti();
                playSound('victory');
                saveGameState();
            }
        }

        // ==================== SOUND SYSTEM ====================
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (!gameState.soundEnabled) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            switch(type) {
                case 'correct':
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                case 'wrong':
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
                case 'levelup':
                    [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.1 + 0.2);
                        osc.start(audioContext.currentTime + i * 0.1);
                        osc.stop(audioContext.currentTime + i * 0.1 + 0.2);
                    });
                    return;
                case 'victory':
                    [523.25, 659.25, 783.99, 1046.50, 1318.51, 1567.98].forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.08);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.08 + 0.3);
                        osc.start(audioContext.currentTime + i * 0.08);
                        osc.stop(audioContext.currentTime + i * 0.08 + 0.3);
                    });
                    return;
            }
        }

        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            document.getElementById('soundToggle').textContent = gameState.soundEnabled ? 'üîä Ljud p√•' : 'üîá Ljud av';
            saveGameState();
        }

        // ==================== ACHIEVEMENTS ====================
        const achievements = [
            { id: 'first_correct', name: 'F√∂rsta stj√§rnan', icon: '‚≠ê', desc: 'Svara r√§tt 1 g√•ng', condition: (s) => s.totalCorrect >= 1 },
            { id: 'ten_correct', name: 'Stigande stj√§rna', icon: 'üåü', desc: 'Svara r√§tt 10 g√•nger', condition: (s) => s.totalCorrect >= 10 },
            { id: 'fifty_correct', name: 'Superstj√§rna', icon: 'üí´', desc: 'Svara r√§tt 50 g√•nger', condition: (s) => s.totalCorrect >= 50 },
            { id: 'hundred_correct', name: 'Mattetrollkarl', icon: 'üßô‚Äç‚ôÄÔ∏è', desc: 'Svara r√§tt 100 g√•nger', condition: (s) => s.totalCorrect >= 100 },
            { id: 'streak_5', name: 'P√• g√•ng', icon: 'üî•', desc: 'F√• en svit p√• 5', condition: (s) => s.bestStreak >= 5 },
            { id: 'streak_10', name: 'Ostoppbar', icon: 'üöÄ', desc: 'F√• en svit p√• 10', condition: (s) => s.bestStreak >= 10 },
            { id: 'streak_20', name: 'Legend', icon: 'üëë', desc: 'F√• en svit p√• 20', condition: (s) => s.bestStreak >= 20 },
            { id: 'level_5', name: 'Blir bra', icon: 'üìö', desc: 'N√• niv√• 5', condition: (s) => s.level >= 5 },
            { id: 'level_10', name: 'Matteexpert', icon: 'üéì', desc: 'N√• niv√• 10', condition: (s) => s.level >= 10 },
            { id: 'daily_goal', name: 'Dagsm√§stare', icon: 'üèÜ', desc: 'Klara dagens m√•l', condition: (s) => s.dailyQuestions >= s.dailyGoal },
            { id: 'boss_slayer', name: 'Bossd√∂dare', icon: '‚öîÔ∏è', desc: 'Besegra en boss', condition: (s) => s.bossesDefeated.length >= 1 },
            { id: 'all_bosses', name: 'M√§stare', icon: 'üåà', desc: 'Besegra alla bossar', condition: (s) => s.bossesDefeated.length >= bosses.length },
            { id: 'theme_collector', name: 'Stilikon', icon: 'üé®', desc: 'L√•s upp 3 teman', condition: (s) => s.unlockedThemes.length >= 3 },
            { id: 'speed_demon', name: 'Blixtsnabb', icon: '‚ö°', desc: 'Svara r√§tt p√• under 2 sekunder', condition: (s) => s.fastAnswer }
        ];

        const levelTitles = [
            'Nyb√∂rjare', 'Elev', 'Student', 'L√§rling', 'Kunnig',
            'Skicklig', 'Avancerad', 'Expert', 'M√§stare', 'Storm√§stare',
            'Legend', 'M√§stare', 'Superstj√§rna', 'Geni', 'Mattedrottning'
        ];

        // ==================== UI MESSAGES ====================
        const encouragements = [
            "Du klarar detta! üí™",
            "Forts√§tt s√•, stj√§rna! ‚≠ê",
            "Du √§r fantastisk! üåü",
            "Blivande mattechampion! üèÜ",
            "Str√•lande jobb! üíé",
            "Du √§r p√• g√•ng! üî•",
            "Inget stoppar dig! üöÄ",
            "S√• stolt √∂ver dig! üíñ",
            "Du √§r naturtalang! üåà",
            "Otroligt fokus! üéØ"
        ];

        const correctMessages = [
            "Perfekt! ‚≠ê", "Fantastiskt! üåü", "Helt r√§tt! üí´", "Briljant! üíé",
            "Superstj√§rna! üåà", "Underbart! üéâ", "Toppen! üíñ", "Utm√§rkt! ‚ú®"
        ];

        const incorrectMessages = [
            "N√§stan! F√∂rs√∂k igen! üí™",
            "S√• n√§ra! Forts√§tt! üåü",
            "Du tar n√§sta! ‚≠ê",
            "Ge inte upp! üíñ"
        ];

        // ==================== GAME LOGIC ====================
        let currentQuestion = { num1: 0, num2: 0, answer: 0 };
        let questionStartTime = 0;
        let timerInterval = null;

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            if (screenId === 'statsScreen') {
                updateStatsScreen();
            }
            if (screenId === 'startScreen') {
                updateDailyProgress();
                updateDailyChallengeCard();
            }
        }

        function startGame(mode) {
            gameState.mode = mode;
            gameState.score = 0;
            gameState.correct = 0;
            gameState.total = 0;
            gameState.streak = 0;

            if (mode !== 'boss') {
                document.getElementById('bossArea').style.display = 'none';
                document.getElementById('timerBar').style.display = 'none';
                document.getElementById('smartIndicator').style.display = 'block';
            }

            showScreen('gameScreen');
            updateDisplay();
            generateQuestion();
            document.getElementById('answerInput').focus();

            // Resume audio context (needed for mobile)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function endGame() {
            if (timerInterval) clearInterval(timerInterval);
            currentBoss = null;
            showScreen('startScreen');
        }

        function generateQuestion() {
            const selected = gameState.mode === 'boss'
                ? { num1: currentBoss.tables[Math.floor(Math.random() * currentBoss.tables.length)], num2: Math.floor(Math.random() * 10) + 1 }
                : selectSmartQuestion();

            currentQuestion = {
                num1: selected.num1,
                num2: selected.num2,
                answer: selected.num1 * selected.num2,
                key: `${selected.num1}x${selected.num2}`
            };

            document.getElementById('question').textContent = `${selected.num1} √ó ${selected.num2} = ?`;
            document.getElementById('answerInput').value = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('tipBox').classList.remove('visible');

            questionStartTime = Date.now();

            // Timer for boss mode
            if (gameState.mode === 'boss') {
                startQuestionTimer();
            }

            // Random encouragement
            if (Math.random() < 0.3) {
                document.getElementById('encouragement').textContent =
                    encouragements[Math.floor(Math.random() * encouragements.length)];
            }
        }

        function startQuestionTimer() {
            const timerFill = document.getElementById('timerFill');
            let timeLeft = 100;

            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                timeLeft -= 2;
                timerFill.style.width = timeLeft + '%';

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    // Time's up - count as wrong
                    handleWrongAnswer(true);
                }
            }, 100);
        }

        function checkAnswer() {
            const input = document.getElementById('answerInput');
            const userAnswer = parseInt(input.value);
            const feedback = document.getElementById('feedback');

            if (isNaN(userAnswer)) {
                feedback.textContent = "Skriv ett tal! üî¢";
                return;
            }

            const responseTime = Date.now() - questionStartTime;

            if (timerInterval) clearInterval(timerInterval);

            // Update fact stats
            if (!factStats[currentQuestion.key]) {
                factStats[currentQuestion.key] = { correct: 0, wrong: 0, totalTime: 0, attempts: 0, lastPracticed: null, streak: 0 };
            }

            factStats[currentQuestion.key].attempts++;
            factStats[currentQuestion.key].totalTime += responseTime;
            factStats[currentQuestion.key].lastPracticed = Date.now();

            // Track daily table practice
            if (!dailyTableCount[currentQuestion.num1]) dailyTableCount[currentQuestion.num1] = 0;
            dailyTableCount[currentQuestion.num1]++;

            gameState.total++;
            gameState.dailyQuestions++;

            if (userAnswer === currentQuestion.answer) {
                handleCorrectAnswer(responseTime);
            } else {
                handleWrongAnswer(false);
            }

            updateDisplay();
            checkAchievements();
            checkDailyChallenge();
            saveGameState();
        }

        function handleCorrectAnswer(responseTime) {
            const feedback = document.getElementById('feedback');

            gameState.correct++;
            gameState.totalCorrect++;
            gameState.streak++;
            factStats[currentQuestion.key].correct++;
            factStats[currentQuestion.key].streak++;

            // Fast answer achievement
            if (responseTime < 2000) {
                gameState.fastAnswer = true;
            }

            // Calculate score
            let points = 10;
            if (gameState.streak > 1) points += gameState.streak * 2;
            if (gameState.mode === 'boss') points *= 2;
            if (responseTime < 3000) points += 5; // Speed bonus

            gameState.score += points;
            gameState.totalScore += points;

            // XP and leveling
            gameState.xp += points;
            while (gameState.xp >= gameState.xpToNext) {
                levelUp();
            }

            // Update best streak
            if (gameState.streak > gameState.bestStreak) {
                gameState.bestStreak = gameState.streak;
            }

            // Boss damage
            if (gameState.mode === 'boss') {
                bossHealth--;
                updateBossHealth();
            }

            // Unlock themes
            checkThemeUnlocks();

            feedback.textContent = correctMessages[Math.floor(Math.random() * correctMessages.length)];
            feedback.className = 'feedback correct';
            playSound('correct');

            // Celebration for streaks
            if (gameState.streak % 5 === 0) {
                createConfetti();
            }

            setTimeout(generateQuestion, 700);
        }

        function handleWrongAnswer(timeout) {
            const feedback = document.getElementById('feedback');

            gameState.streak = 0;
            factStats[currentQuestion.key].wrong++;
            factStats[currentQuestion.key].streak = 0;

            if (timeout) {
                feedback.textContent = `Tiden tog slut! Svaret var ${currentQuestion.answer}`;
            } else {
                feedback.textContent = `${incorrectMessages[Math.floor(Math.random() * incorrectMessages.length)]} Svaret var ${currentQuestion.answer}`;
            }

            feedback.className = 'feedback incorrect';
            playSound('wrong');

            // Show tip
            const tip = getTipForQuestion(currentQuestion.num1, currentQuestion.num2);
            if (tip) {
                document.getElementById('tipContent').innerHTML = tip;
                document.getElementById('tipBox').classList.add('visible');
            }

            setTimeout(generateQuestion, 3500);
        }

        function levelUp() {
            gameState.level++;
            gameState.xp -= gameState.xpToNext;
            gameState.xpToNext = Math.floor(gameState.xpToNext * 1.15);
            createConfetti();
            playSound('levelup');
        }

        function checkThemeUnlocks() {
            for (const [key, theme] of Object.entries(themes)) {
                if (!gameState.unlockedThemes.includes(key) && gameState.totalScore >= theme.cost * 2) {
                    // Auto-unlock at double the cost as a reward
                }
            }
        }

        function updateDisplay() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('correct').textContent = gameState.correct;
            document.getElementById('total').textContent = gameState.total;
            document.getElementById('streak').textContent = gameState.streak;

            document.getElementById('streakFire').style.display = gameState.streak > 0 ? 'inline' : 'none';

            document.getElementById('levelText').textContent = `Niv√• ${gameState.level}`;
            document.getElementById('levelTitle').textContent = levelTitles[Math.min(gameState.level - 1, levelTitles.length - 1)];

            const xpPercent = (gameState.xp / gameState.xpToNext) * 100;
            document.getElementById('xpBar').style.width = `${xpPercent}%`;
        }

        function updateDailyProgress() {
            const progress = Math.min(gameState.dailyQuestions, gameState.dailyGoal);
            document.getElementById('dailyProgress').textContent = `${progress} / ${gameState.dailyGoal} fr√•gor`;
            document.getElementById('dailyProgressBar').style.width = `${(progress / gameState.dailyGoal) * 100}%`;
        }

        function updateStatsScreen() {
            document.getElementById('totalCorrectStat').textContent = gameState.totalCorrect;
            document.getElementById('bestStreakStat').textContent = gameState.bestStreak;
            document.getElementById('levelStat').textContent = gameState.level;
            renderHeatmap();
            renderBadges('statsBadges');
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmap');
            container.innerHTML = '';

            // Header row
            const corner = document.createElement('div');
            corner.className = 'heatmap-cell';
            corner.textContent = '√ó';
            container.appendChild(corner);

            for (let i = 1; i <= 10; i++) {
                const header = document.createElement('div');
                header.className = 'heatmap-cell heatmap-header';
                header.textContent = i;
                container.appendChild(header);
            }

            // Data rows
            for (let i = 1; i <= 10; i++) {
                const rowHeader = document.createElement('div');
                rowHeader.className = 'heatmap-cell heatmap-header';
                rowHeader.textContent = i;
                container.appendChild(rowHeader);

                for (let j = 1; j <= 10; j++) {
                    const cell = document.createElement('div');
                    const key = `${i}x${j}`;
                    const stat = factStats[key];

                    let className = 'heatmap-cell heatmap-new';

                    if (stat && stat.attempts > 0) {
                        const accuracy = stat.correct / stat.attempts;
                        if (accuracy >= 0.9 && stat.attempts >= 5) className = 'heatmap-cell heatmap-mastered';
                        else if (accuracy >= 0.7) className = 'heatmap-cell heatmap-good';
                        else if (accuracy >= 0.5) className = 'heatmap-cell heatmap-learning';
                        else className = 'heatmap-cell heatmap-weak';
                    }

                    cell.className = className;
                    cell.textContent = i * j;
                    cell.title = stat ? `${i}√ó${j}: ${Math.round((stat.correct/stat.attempts)*100)}% r√§tt (${stat.attempts} f√∂rs√∂k)` : `${i}√ó${j}: Ej √∂vad`;
                    container.appendChild(cell);
                }
            }
        }

        function checkAchievements() {
            achievements.forEach(achievement => {
                if (!gameState.achievements[achievement.id] && achievement.condition(gameState)) {
                    gameState.achievements[achievement.id] = true;
                    createConfetti();
                }
            });
        }

        function renderBadges(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            achievements.forEach(achievement => {
                const badge = document.createElement('div');
                badge.className = `badge ${gameState.achievements[achievement.id] ? 'unlocked' : 'locked'}`;
                badge.innerHTML = `
                    ${achievement.icon}
                    <span class="badge-tooltip">${achievement.name}: ${achievement.desc}</span>
                `;
                container.appendChild(badge);
            });
        }

        function setupTableSelect() {
            const container = document.getElementById('tableSelect');
            container.innerHTML = '';

            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement('button');
                btn.className = 'table-btn';
                btn.textContent = i;

                if (gameState.selectedTables.includes(i)) btn.classList.add('selected');

                // Check if mastered
                let mastered = true;
                for (let j = 1; j <= 10; j++) {
                    const key = `${i}x${j}`;
                    const stat = factStats[key];
                    if (!stat || stat.attempts < 5 || (stat.correct / stat.attempts) < 0.9) {
                        mastered = false;
                        break;
                    }
                }
                if (mastered) btn.classList.add('mastered');

                btn.onclick = () => {
                    const idx = gameState.selectedTables.indexOf(i);
                    if (idx > -1 && gameState.selectedTables.length > 1) {
                        gameState.selectedTables.splice(idx, 1);
                        btn.classList.remove('selected');
                    } else if (idx === -1) {
                        gameState.selectedTables.push(i);
                        btn.classList.add('selected');
                    }
                    saveGameState();
                };

                container.appendChild(btn);
            }
        }

        function createConfetti() {
            const celebration = document.getElementById('celebration');
            const colors = ['#667eea', '#764ba2', '#f093fb', '#ffecd2', '#fcb69f', '#00b894', '#fddb92'];

            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                celebration.appendChild(confetti);

                setTimeout(() => confetti.remove(), 3000);
            }
        }

        // ==================== PERSISTENCE ====================
        function saveGameState() {
            localStorage.setItem('mathStarsState', JSON.stringify(gameState));
            localStorage.setItem('mathStarsFactStats', JSON.stringify(factStats));
        }

        function loadGameState() {
            const saved = localStorage.getItem('mathStarsState');
            if (saved) {
                const parsed = JSON.parse(saved);
                gameState = { ...gameState, ...parsed };
            }
            const savedFacts = localStorage.getItem('mathStarsFactStats');
            if (savedFacts) {
                factStats = JSON.parse(savedFacts);
            }
        }

        function checkDailyReset() {
            const today = new Date().toDateString();
            if (gameState.lastPlayDate !== today) {
                gameState.dailyQuestions = 0;
                gameState.dailyChallengeCompleted = false;
                gameState.lastPlayDate = today;
                dailyTableCount = {};
                saveGameState();
            }
        }

        // ==================== INITIALIZATION ====================
        function init() {
            loadGameState();
            initFactStats();
            checkDailyReset();
            applyTheme(gameState.currentTheme);
            setupTableSelect();
            renderThemeSelector();
            updateDailyProgress();
            updateDailyChallengeCard();

            document.getElementById('soundToggle').textContent = gameState.soundEnabled ? 'üîä Ljud p√•' : 'üîá Ljud av';

            // Keyboard support
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && document.getElementById('gameScreen').classList.contains('active')) {
                    checkAnswer();
                }
            });
        }

        init();
    </script>
</body>
</html>
